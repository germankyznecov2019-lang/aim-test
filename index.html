<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Face AR Pro</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: -apple-system, sans-serif; }
        
        #container { position: relative; width: 100vw; height: 100vh; }
        
        video { 
            width: 100%; height: 100%; object-fit: cover; 
            /* По умолчанию зеркалим (для селфи), JS это поправит при переключении */
            transform: scaleX(-1); 
        }
        
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* Эффект фонарика для селфи (белый экран) */
        .flash-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
            mix-blend-mode: overlay;
        }

        /* Кнопки управления (Стекло) */
        .controls {
            position: absolute; bottom: 40px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px;
            z-index: 50;
        }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; width: 60px; height: 60px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            cursor: pointer; transition: transform 0.1s, background 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.25); }
        .btn svg { width: 28px; height: 28px; fill: white; filter: drop-shadow(0 0 2px rgba(0,0,0,0.5)); }

        /* Статус (FPS и состояние) */
        .status-pill {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(10px);
            padding: 8px 16px; border-radius: 20px;
            color: #00ffcc; font-size: 13px; font-weight: 600;
            border: 1px solid rgba(0, 255, 204, 0.2);
            pointer-events: none;
        }

        /* Загрузчик */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #00ffcc; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #00ffcc; border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div id="loader-text">Загрузка нейросети...</div>
    </div>

    <div id="container">
        <video id="video" autoplay muted playsinline></video>
        <div class="flash-overlay" id="flash-overlay"></div>
        <canvas id="canvas"></canvas>
        
        <div class="status-pill" id="status-text">Инициализация...</div>

        <div class="controls">
            <div class="btn" onclick="switchCamera()">
                <svg viewBox="0 0 24 24"><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5V13H9v2.5L5.5 12 9 8.5V11h6V8.5l3.5 3.5-3.5 3.5z"/></svg>
            </div>
            <div class="btn" onclick="toggleFlash()">
                <svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusText = document.getElementById('status-text');
        const loader = document.getElementById('loader');
        const flashOverlay = document.getElementById('flash-overlay');

        let isModelLoaded = false;
        let currentFacingMode = 'user'; // 'user' - фронталка, 'environment' - задняя
        let isFlashOn = false;
        let detectionLoop; // Переменная для контроля цикла

        // Настройки детектора (Баланс скорости и дальности)
        // inputSize: 320 видит дальше, чем 224, но чуть медленнее. 
        // scoreThreshold: 0.3 позволяет видеть "неуверенные" лица (в темноте или далеко)
        const DETECTOR_OPTIONS = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.3 });
        const MODELS_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        async function init() {
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODELS_URL);
                isModelLoaded = true;
                document.getElementById('loader-text').innerText = "Запуск камеры...";
                startCamera();
            } catch (e) {
                alert("Ошибка загрузки: " + e.message);
            }
        }

        async function startCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 } // Просим 30 FPS у браузера
                    }
                });
                video.srcObject = stream;

                // Зеркалим видео только если это фронталка
                video.style.transform = currentFacingMode === 'user' ? 'scaleX(-1)' : 'scaleX(1)';

                video.onloadedmetadata = () => {
                    video.play();
                    // Скрываем загрузчик только после первого старта
                    if(loader.style.display !== 'none') {
                        loader.style.opacity = 0;
                        setTimeout(() => loader.style.display = 'none', 500);
                    }
                    startTracking();
                };
            } catch (err) {
                statusText.innerText = "Ошибка доступа к камере";
                statusText.style.color = "red";
            }
        }

        async function startTracking() {
            if (detectionLoop) cancelAnimationFrame(detectionLoop);

            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            // Рекурсивная функция для максимального FPS
            const tick = async () => {
                if (video.paused || video.ended) return;

                const t0 = performance.now();

                // Детекция
                const detections = await faceapi.detectAllFaces(video, DETECTOR_OPTIONS);
                const resizedDetections = faceapi.resizeResults(detections, displaySize);

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (resizedDetections.length > 0) {
                    statusText.style.color = "#00ffcc";
                    statusText.innerText = `Цель захвачена`;
                } else {
                    statusText.style.color = "rgba(255,255,255,0.7)";
                    statusText.innerText = "Поиск...";
                }

                resizedDetections.forEach(d => {
                    const box = d.box;
                    let x = box.x;
                    
                    // Если фронталка, нужно зеркалить координаты отрисовки
                    if (currentFacingMode === 'user') {
                        x = displaySize.width - (box.x + box.width);
                    }

                    // Рисуем
                    const centerX = x + box.width / 2;
                    const centerY = box.y + box.height / 2;
                    const radius = box.width / 1.5; // Чуть больше лица

                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                    
                    // Эффект прицела/сканера
                    ctx.strokeStyle = "rgba(255, 255, 255, 0.9)";
                    ctx.lineWidth = 3;
                    ctx.shadowColor = "#00ffcc";
                    ctx.shadowBlur = 20;
                    ctx.stroke();
                });

                // Замер FPS (очень грубый, но информативный)
                // const t1 = performance.now();
                // console.log("FPS: " + Math.round(1000 / (t1 - t0)));

                detectionLoop = requestAnimationFrame(tick);
            };

            tick();
        }

        // --- ФУНКЦИИ КНОПОК ---

        function switchCamera() {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            startCamera();
        }

        function toggleFlash() {
            isFlashOn = !isFlashOn;
            
            // Метод 1: Экранная вспышка (для фронталки)
            flashOverlay.style.opacity = isFlashOn ? 1 : 0;

            // Метод 2: Аппаратный фонарик (для задней камеры)
            // Работает не во всех браузерах, но попробуем
            const track = video.srcObject.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            
            if (capabilities.torch) {
                track.applyConstraints({
                    advanced: [{ torch: isFlashOn }]
                }).catch(e => console.log("Фонарик не поддерживается: ", e));
            }
        }

        // Адаптация под поворот
        window.addEventListener('resize', () => {
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);
        });

        init();
    </script>
</body>
</html>
