<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI HUD Debug</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        .container { position: relative; width: 100vw; height: 100vh; }
        .input_video { display: none; }
        .output_canvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; object-fit: cover; }
        
        /* HUD Layer */
        .hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 10px;
            color: white;
            text-align: center;
        }

        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0a; z-index: 20;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: #0f0; padding: 20px; text-align: center;
        }
        
        #error-log { color: #ff3333; margin-top: 20px; font-size: 12px; max-width: 80%; word-wrap: break-word; }
        
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid rgba(0, 255, 0, 0.3);
            border-top: 4px solid #0f0; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div id="status-text">LOADING AI CORE...</div>
        <div id="error-log"></div>
    </div>

    <div class="container">
        <video class="input_video" playsinline muted autoplay></video>
        <canvas class="output_canvas"></canvas>
        
        <div class="hud-layer">
            <div class="glass-panel" style="align-self: flex-start;">
                TARGET LOCKED: <span id="conf-score">--</span>
            </div>
            <div class="glass-panel" style="align-self: center; margin-bottom: 20px;">
                FPS: <span id="fps-counter">0</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js" crossorigin="anonymous"></script>

    <script>
        // --- СИСТЕМА ОТЛОВКИ ОШИБОК ---
        function logError(msg) {
            document.getElementById('error-log').innerText = "ERR: " + msg;
            document.getElementById('status-text').innerText = "SYSTEM FAILURE";
            document.querySelector('.spinner').style.borderColor = 'red';
        }
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            logError(msg + " line: " + lineNo);
            return false;
        };
        // ------------------------------

        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');
        const loader = document.getElementById('loader');
        
        let lastTime = 0;
        // Переменные анимации
        let currX=0, currY=0, currR=0, targetX=0, targetY=0, targetR=0;

        function onResults(results) {
            // Успешный запуск - скрываем лоадер
            if (loader.style.display !== 'none') loader.style.display = 'none';

            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // Отражаем и рисуем
            canvasCtx.translate(canvasElement.width, 0);
            canvasCtx.scale(-1, 1);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.detections.length > 0) {
                const det = results.detections[0];
                const box = det.boundingBox;
                
                // Координаты (упрощенные для полного экрана)
                targetX = box.xCenter * canvasElement.width;
                targetY = box.yCenter * canvasElement.height;
                targetR = (box.width * canvasElement.width) / 1.5;
                
                document.getElementById('conf-score').innerText = Math.round(det.categories[0].score * 100) + "%";
            } else {
                targetR = 0; // Если лицо пропало, радиус в 0
            }

            // Плавность (Lerp)
            currX += (targetX - currX) * 0.2;
            currY += (targetY - currY) * 0.2;
            currR += (targetR - currR) * 0.2;

            // Рисуем круг
            if (currR > 1) {
                canvasCtx.beginPath();
                canvasCtx.arc(currX, currY, currR, 0, 2 * Math.PI);
                canvasCtx.lineWidth = 3;
                canvasCtx.strokeStyle = "rgba(255, 255, 255, 0.9)";
                canvasCtx.shadowBlur = 20;
                canvasCtx.shadowColor = "white";
                canvasCtx.stroke();
            }
            
            canvasCtx.restore();

            // FPS
            const now = performance.now();
            if (now - lastTime >= 1000) {
                 // Упрощенный FPS
            }
            document.getElementById('fps-counter').innerText = Math.round(1000 / (now - lastTime));
            lastTime = now;
        }

        try {
            const faceDetection = new FaceDetection({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`;
            }});

            faceDetection.setOptions({
                modelSelection: 0, // 0 - легче и быстрее (Short Range), лучше для селфи
                minDetectionConfidence: 0.5
            });
            
            faceDetection.onResults(onResults);

            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await faceDetection.send({image: videoElement});
                },
                width: 640, // Снизил разрешение для скорости загрузки
                height: 480,
                facingMode: "user"
            });

            camera.start()
                .then(() => console.log("Camera started"))
                .catch(e => logError("Camera Access Denied: " + e.message));

        } catch (e) {
            logError("Init Error: " + e.message);
        }
    </script>
</body>
</html>
