<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoTycoon TON - –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –î–∏–∑–∞–π–Ω</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ª—É—á—à–µ –æ—Ç–∫–ª—é—á–∏—Ç—å)
        setLogLevel('debug');

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Firebase
        window.firebase = {
            db: null,
            auth: null,
            userId: null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
            userIsReady: false,
        };

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                window.firebase.db = getFirestore(app);
                window.firebase.auth = getAuth(app);
                
                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                const auth = window.firebase.auth;
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ userId
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.firebase.userId = user.uid;
                        window.firebase.userIsReady = true;
                        if (window.onFirebaseReady) {
                            window.onFirebaseReady();
                        }
                    } else if (!window.firebase.userIsReady) {
                         // –í —Å–ª—É—á–∞–µ –≤—ã—Ö–æ–¥–∞ –∏–ª–∏ –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –≥–æ—Ç–æ–≤–æ), –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥
                         signInAnonymously(auth).then(result => {
                             window.firebase.userId = result.user.uid;
                             window.firebase.userIsReady = true;
                             if (window.onFirebaseReady) {
                                window.onFirebaseReady();
                             }
                         });
                    }
                });

            } catch (error) {
                console.error("FIREBASE FATAL ERROR (using local mode):", error);
                // –í —Å–ª—É—á–∞–µ —Ñ–∞—Ç–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–∏, –∑–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
                setTimeout(() => {
                    window.firebase = { userId: 'local-test-user', userIsReady: true, appId: 'local', db: null, auth: null };
                    if (window.onFirebaseReady) {
                         window.onFirebaseReady();
                    }
                }, 100);
            }
        }
        
        initializeFirebase();
    </script>
    
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Glassmorphism (–°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0f19; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            background-image: linear-gradient(135deg, #1c2738 0%, #0b0f19 100%);
            color: #e5e7eb; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
            min-height: 100vh;
            transition: background 0.3s;
            /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª, –µ—Å–ª–∏ TWA –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è */
            overflow-x: hidden; 
        }

        /* Loading Overlay Style */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0b0f19;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Spinner style (simple animation) */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #0098EA;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        .glass-card {
            background: rgba(255, 255, 255, 0.08); /* –°–≤–µ—Ç–ª–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
            border-radius: 18px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(12px); /* –≠—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–º—ã—Ç–∏—è */
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .glass-card:hover {
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4), 0 0 50px rgba(0, 152, 234, 0.1);
            transform: translateY(-2px);
        }

        .ton-gradient {
            background-image: linear-gradient(90deg, #0098EA, #00AEEF);
        }
        .ton-glow {
            text-shadow: 0 0 12px rgba(0, 152, 234, 0.7);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ (iOS-–ø–æ–¥–æ–±–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è) */
        .glass-button {
            border-radius: 12px;
            padding: 14px 24px; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —Ç–∞—á-–∑–æ–Ω—ã */
            font-weight: 600;
            transition: transform 0.15s, box-shadow 0.15s, opacity 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 48px; /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ç–∞—á-–∑–æ–Ω—ã */
        }

        .glass-button:active {
            transform: scale(0.96);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .glass-button:disabled {
            opacity: 0.4;
            transform: none;
            cursor: not-allowed;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ */
        .tab-button {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            color: #9ca3af;
            padding: 16px 12px; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –ø–∞–¥–¥–∏–Ω–≥ –¥–ª—è —Ç–∞—á-–∑–æ–Ω—ã */
        }
        .tab-button.active {
            border-bottom: 3px solid #0098EA;
            color: #0098EA;
            font-weight: 600;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ */
        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: border-color 0.3s;
            min-height: 48px; /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ç–∞—á-–∑–æ–Ω—ã */
        }
        .glass-input:focus {
            outline: none;
            border-color: #0098EA;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –ø–ª–∞–≤–∞—é—â–µ–≥–æ –º–µ–Ω—é */
        .sticky-tabs {
             background: rgba(11, 15, 25, 0.85); /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
             backdrop-filter: blur(8px);
             -webkit-backdrop-filter: blur(8px);
             /* –ú–æ–±–∏–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∫–ª–∞–¥–æ–∫ */
             white-space: nowrap; 
             overflow-x: auto;
             -webkit-overflow-scrolling: touch;
        }
        .sticky-tabs::-webkit-scrollbar {
             display: none; /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –Ω–∞ Android */
        }

    </style>
</head>
<body class="pb-20">

<!-- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò -->
<div id="loading-overlay">
    <div class="spinner mb-4"></div>
    <p class="text-xl text-white ton-glow font-bold">–ó–∞–≥—Ä—É–∑–∫–∞ CryptoTycoon...</p>
</div>

<div id="app-container" class="max-w-xl mx-auto w-full p-4">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ë–∞–ª–∞–Ω—Å (Glass Card) -->
    <header class="p-5 mb-6 glass-card shadow-2xl">
        <h1 class="text-3xl font-bold text-white ton-glow">CryptoTycoon TON</h1>
        <p class="text-sm mt-1 text-gray-400 opacity-80">ID: <span id="profile-id" class="text-xs font-mono">...</span></p>
        
        <div class="mt-4 flex flex-col sm:flex-row gap-3">
            <div class="bg-white/5 p-3 rounded-xl flex-1 font-mono border border-white/10 min-w-0">
                <span class="text-xs text-gray-400 block">–ö—É—Ä—Å:</span>
                <p class="text-xl font-bold text-yellow-300">$<span id="display-ton-price">15.00</span> / TON</p>
            </div>
            
            <div class="bg-white/5 p-3 rounded-xl flex-1 font-mono border border-white/10 min-w-0">
                <span class="text-xs text-gray-400">USD –ë–∞–ª–∞–Ω—Å:</span>
                <p class="text-xl font-bold text-green-300">$<span id="display-usd">0.00</span></p>
            </div>
            
            <div class="bg-white/5 p-3 rounded-xl flex-1 font-mono border border-white/10 min-w-0">
                <span class="text-xs text-gray-400">TON –ë–∞–ª–∞–Ω—Å:</span>
                <p class="text-xl font-bold text-white ton-glow"><span id="display-ton">0.0000</span> üíé</p>
            </div>
        </div>
    </header>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º (–°—Ç–µ–∫–ª—è–Ω–Ω–∞—è, –ø—Ä–∏–ª–∏–ø–∞—é—â–∞—è) -->
    <div class="flex border-b border-white/10 mb-6 sticky top-0 z-10 sticky-tabs rounded-b-xl">
        <button id="tab-farm" onclick="changeTab('farm')" class="tab-button flex-shrink-0 text-center active">‚õè –§–µ—Ä–º–∞</button>
        <button id="tab-shop" onclick="changeTab('shop')" class="tab-button flex-shrink-0 text-center">üñ• –ú–∞–≥–∞–∑–∏–Ω</button>
        <button id="tab-bank" onclick="changeTab('bank')" class="tab-button flex-shrink-0 text-center">üè¶ –ë–∞–Ω–∫</button>
        <button id="tab-wallet" onclick="changeTab('wallet')" class="tab-button flex-shrink-0 text-center">üëõ –ö–æ—à–µ–ª–µ–∫</button>
        <button id="tab-nft" onclick="changeTab('nft')" class="tab-button flex-shrink-0 text-center">üñº NFT</button>
    </div>

    <!-- –ö–û–ù–¢–ï–ù–¢ –í–ö–õ–ê–î–û–ö -->
    
    <!-- 1. –§–ï–†–ú–ê (–ú–ê–ô–ù–ò–ù–ì) -->
    <div id="content-farm" class="tab-content">
        <section class="mb-8 p-4 glass-card">
            <h2 class="text-2xl font-semibold mb-4 text-blue-300 flex justify-between items-center">
                –ü–∞—Å—Å–∏–≤–Ω—ã–π –ú–∞–π–Ω–∏–Ω–≥ 
                <span id="passive-rate" class="text-base text-gray-400">0.00 TON/–º–∏–Ω</span>
            </h2>
            
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 p-4 glass-card !shadow-none !bg-white/5 border-white/10">
                <span class="text-lg mb-2 sm:mb-0">–ù–∞–∫–æ–ø–ª–µ–Ω–æ:</span>
                <span id="pending-ton" class="text-2xl font-bold text-yellow-400 ton-glow">0.0000 TON</span>
            </div>

            <button onclick="collectPassiveIncome()" id="collect-button" class="w-full glass-button ton-gradient text-white disabled:opacity-50" disabled>
                –°–æ–±—Ä–∞—Ç—å –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è
            </button>
            
            <div id="mining-feedback" class="mt-4 p-3 rounded-xl hidden text-center font-mono"></div>
        </section>

        <!-- –†–∞–∑–¥–µ–ª –û–±–º–µ–Ω –∏ –ö—É—Ä—Å -->
        <section class="mt-8 p-4 glass-card">
            <h2 class="text-2xl font-semibold mb-4 text-blue-300">üí± –û–±–º–µ–Ω TON</h2>
            <div class="bg-white/5 p-4 rounded-xl border border-white/10">
                <p class="text-sm text-gray-400 mb-3">–û–±–º–µ–Ω –≤—Å–µ–≥–æ TON –Ω–∞ USD –ø–æ —Ç–µ–∫—É—â–µ–º—É –∫—É—Ä—Å—É: $<span id="current-exchange-rate">15.00</span></p>
                <button onclick="exchangeTonToUsd()" class="w-full glass-button bg-indigo-600 hover:bg-indigo-700 text-white disabled:opacity-30" id="exchange-button">
                    –û–±–º–µ–Ω—è—Ç—å –í–µ—Å—å TON
                </button>
            </div>
        </section>
    </div>
    
    <!-- 2. –ú–ê–ì–ê–ó–ò–ù –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø -->
    <div id="content-shop" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-blue-300">üñ• –î–æ—Å—Ç—É–ø–Ω—ã–µ GPU (30 –º–æ–¥–µ–ª–µ–π)</h2>
        <div id="shop-feedback" class="mb-4 p-3 rounded-xl hidden text-center font-mono"></div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ 30 GPU -->
        <div id="gpu-list-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã 30 –∫–∞—Ä—Ç–æ—á–µ–∫ GPU -->
        </div>

        <!-- ASIC (–î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ) -->
        <h2 class="text-2xl font-semibold mt-8 mb-4 text-blue-300">ASIC-–º–∞–π–Ω–µ—Ä—ã</h2>
        <div class="glass-card p-4 flex flex-col sm:flex-row items-center justify-between">
            <div class="mb-3 sm:mb-0">
                <p class="text-xl font-semibold text-white">ASIC-–º–∞–π–Ω–µ—Ä X-30</p>
                <p class="text-sm text-gray-400">–î–æ—Ö–æ–¥: +0.25 TON/–º–∏–Ω</p>
                <p class="text-sm text-gray-400">–í –Ω–∞–ª–∏—á–∏–∏: <span id="asic-count">0</span></p>
            </div>
            <div class="text-right w-full sm:w-auto">
                <p class="text-green-400 font-bold text-2xl">500 $</p>
                <button onclick="buyEquipment('asic', 500, 0.25)" id="buy-asic-button" class="glass-button ton-gradient text-white text-sm mt-2 disabled:opacity-30">
                    –ö—É–ø–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
    
    <!-- 3. –ë–ê–ù–ö (–î–ï–ü–û–ó–ò–¢–´) -->
    <div id="content-bank" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-blue-300">üè¶ –ú–µ–∂–ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω—ã–π –ë–∞–Ω–∫</h2>
        <div id="bank-feedback" class="mb-4 p-3 rounded-xl hidden text-center font-mono"></div>

        <div class="p-4 glass-card mb-6">
            <p class="text-xl font-mono text-green-300 mb-3 border-b border-white/10 pb-3">–í–∞—à USD-–±–∞–ª–∞–Ω—Å: <span id="bank-usd-balance">0.00</span> $</p>
            
            <h3 class="text-lg font-semibold text-white mb-2 mt-3">--- –î–µ–ø–æ–∑–∏—Ç ---</h3>
            <p class="text-sm text-gray-400">–°—É–º–º–∞ –Ω–∞ –≤–∫–ª–∞–¥–µ: <span id="bank-deposit-amount" class="text-yellow-400 font-mono">0.0000</span> $</p>
            <p class="text-sm text-gray-400">–û–±—â–∞—è –°—Ç–∞–≤–∫–∞: <span id="bank-interest-rate" class="text-cyan-400 font-bold">5.00%</span> –≤ —á–∞—Å</p>
            <p class="text-sm text-gray-400 mb-3">–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ %: +<span id="bank-accumulated-interest" class="text-green-400 font-mono">0.0000</span> $</p>
            
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="bankDeposit(100)" id="deposit-100-btn" class="glass-button bg-green-700/80 hover:bg-green-700 text-white text-sm disabled:opacity-30 !py-3">
                    –í–Ω–µ—Å—Ç–∏ 100 $
                </button>
                <button onclick="bankWithdraw(100)" id="withdraw-100-btn" class="glass-button bg-red-700/80 hover:bg-red-700 text-white text-sm disabled:opacity-30 !py-3">
                    –°–Ω—è—Ç—å 100 $
                </button>
                <button onclick="bankDeposit('all')" id="deposit-all-btn" class="glass-button bg-green-900/80 hover:bg-green-900 text-white text-sm disabled:opacity-30 !py-3">
                    –í–Ω–µ—Å—Ç–∏ –í—Å–µ
                </button>
                <button onclick="bankWithdraw('all')" id="withdraw-all-btn" class="glass-button bg-red-900/80 hover:bg-red-900 text-white text-sm disabled:opacity-30 !py-3">
                    –°–Ω—è—Ç—å –í—Å–µ
                </button>
            </div>
        </div>
        
        <!-- –£–ª—É—á—à–µ–Ω–∏–µ –ü—Ä–æ—Ü–µ–Ω—Ç–æ–≤ -->
        <div class="p-4 glass-card border border-cyan-500/50">
            <h3 class="text-xl font-semibold mb-2 text-cyan-400">üìà –£–ª—É—á—à–µ–Ω–∏–µ –ü—Ä–æ—Ü–µ–Ω—Ç–æ–≤</h3>
            <p class="text-sm text-gray-400 mb-3">–£–ª—É—á—à–∏—Ç—å —Å—Ç–∞–≤–∫—É –Ω–∞ **+2.00%** –∑–∞ **500 $** (–¢–µ–∫—É—â–∞—è: <span id="current-interest-rate-upgrade">5.00</span>%)</p>
            <button onclick="upgradeInterest()" id="upgrade-interest-btn" class="w-full glass-button bg-cyan-600/80 hover:bg-cyan-600 text-white disabled:opacity-30">
                –£–ª—É—á—à–∏—Ç—å (+2.00%)
            </button>
        </div>
    </div>

    <!-- 4. –ö–û–®–ï–õ–ï–ö (–ü–ï–†–ï–í–û–î–´) -->
    <div id="content-wallet" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-blue-300">üëõ –ö–æ—à–µ–ª–µ–∫</h2>
        <div id="wallet-feedback" class="mb-4 p-3 rounded-xl hidden text-center font-mono"></div>

        <div class="p-4 glass-card mb-6">
            <p class="text-xl font-mono text-green-300 mb-4 border-b border-white/10 pb-3">–í–∞—à USD-–±–∞–ª–∞–Ω—Å: <span id="wallet-usd-balance">0.00</span> $</p>

            <h3 class="text-lg font-semibold text-white mb-2">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–µ–Ω—å–≥–∏ –¥—Ä—É–≥—É</h3>
            <p class="text-sm text-yellow-400 mb-3">
                *–í–Ω–∏–º–∞–Ω–∏–µ: —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –æ–¥–Ω–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å—Ä–µ–¥—ã.
            </p>
            
            <input type="text" id="recipient-id" placeholder="ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è (UserID)" class="w-full p-3 mb-2 glass-input rounded-lg text-white placeholder-gray-400">
            <input type="number" id="transfer-amount" placeholder="–°—É–º–º–∞ –≤ USD" class="w-full p-3 mb-4 glass-input rounded-lg text-white placeholder-gray-400" min="0.01" step="0.01">
            
            <button onclick="sendMoney()" id="send-money-btn" class="w-full glass-button ton-gradient text-white disabled:opacity-30">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </div>

        <div class="p-4 glass-card">
            <h3 class="text-lg font-semibold text-white mb-2">–í–∞—à ID –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è</h3>
            <div class="flex items-center bg-white/5 p-3 rounded-xl border border-white/10">
                <span id="wallet-user-id" class="flex-grow font-mono text-sm break-all">...</span>
                <button onclick="copyUserId()" class="ml-3 px-3 py-1 glass-button bg-gray-600/80 hover:bg-gray-600 text-white text-xs">
                    –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- 5. NFT -->
    <div id="content-nft" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-blue-300">üñº NFT –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</h2>
        <div id="nft-feedback" class="mb-4 p-3 rounded-xl hidden text-center font-mono"></div>

        <!-- YOUTUBE NFT –†–∞—Å–ø—Ä–æ–¥–∞–∂–∞ (–õ–∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–¥–∞–Ω–∏–µ) -->
        <div class="glass-card p-4 mb-6 border border-yellow-500/50">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2">
                <p class="text-xl font-semibold text-white flex items-center mb-2 sm:mb-0">
                    <!-- SVG-–ª–æ–≥–æ—Ç–∏–ø YouTube -->
                    <svg class="mr-2 w-6 h-6 text-red-600 fill-current" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M19.61 6.31C19.1 5.76 18.42 5.37 17.65 5.16C15.82 4.67 12 4.67 12 4.67C12 4.67 8.18 4.67 6.35 5.16C5.58 5.37 4.9 5.76 4.39 6.31C3.84 6.89 3.52 7.57 3.39 8.35C3.12 10.05 3.12 12 3.12 12C3.12 12 3.12 13.95 3.39 15.65C3.52 16.43 3.84 17.11 4.39 17.69C4.9 18.24 5.58 18.63 6.35 18.84C8.18 19.33 12 19.33 12 19.33C12 19.33 15.82 19.33 17.65 18.84C18.42 18.63 19.1 18.24 19.61 17.69C20.16 17.11 20.48 16.43 20.61 15.65C20.88 13.95 20.88 12 20.88 12C20.88 12 20.88 10.05 20.61 8.35C20.48 7.57 20.16 6.89 19.61 6.31ZM10.5 15.3V8.7L15.6 12L10.5 15.3Z" fill="currentColor"/>
                    </svg>
                    YouTube NFT (–õ–∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–¥–∞–Ω–∏–µ)
                </p>
                <p class="text-2xl font-bold text-yellow-400">100,000 $</p>
            </div>
            <p class="text-sm text-gray-400 mb-3">
                –í—Å–µ–≥–æ –≤ –º–∏—Ä–µ: 3 —à—Ç. –î–æ—Ö–æ–¥: +100.00 TON/–º–∏–Ω –∑–∞ —à—Ç—É–∫—É.
            </p>
            <div class="flex justify-between items-center text-sm text-gray-300 mb-4">
                <span>–í –Ω–∞–ª–∏—á–∏–∏: <span id="youtube-nft-stock">3</span> / 3</span>
                <span>–í–∞—à–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—è: <span id="youtube-nft-owned">0</span></span>
            </div>
            <button onclick="buyYoutubeNft()" id="buy-youtube-nft-button" class="w-full glass-button bg-yellow-600/80 hover:bg-yellow-600 text-gray-900 font-bold disabled:opacity-30">
                –ö—É–ø–∏—Ç—å NFT
            </button>
        </div>

        <!-- –ü–æ–∫—É–ø–∫–∞ NFT –ë–æ–∫—Å–∞ -->
        <div class="glass-card p-4 mb-6 border border-purple-500/50">
            <div class="flex justify-between items-center mb-4">
                <p class="text-xl font-semibold text-white">Mystery Box</p>
                <p class="text-2xl font-bold text-purple-400">100 $</p>
            </div>
            <p class="text-sm text-gray-400 mb-4">
                –®–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å NFT: –†–µ–¥–∫–∏–π (+0.5 TON/–º–∏–Ω) –∏–ª–∏ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π (+2.0 TON/–º–∏–Ω)
            </p>
            <button onclick="buyNFTBox()" class="w-full glass-button bg-purple-600/80 hover:bg-purple-600 text-white disabled:opacity-30" id="buy-nft-button">
                –û—Ç–∫—Ä—ã—Ç—å –ë–æ–∫—Å
            </button>
        </div>

        <h3 class="text-xl font-semibold mt-8 mb-3 text-white">–í–∞—à–∞ –ö–æ–ª–ª–µ–∫—Ü–∏—è</h3>
        <div id="user-nft-collection" class="grid grid-cols-2 gap-4">
            <div id="nft-rare-display" class="glass-card p-3 text-center !bg-white/5">
                <p class="text-2xl">‚≠ê</p>
                <p class="font-semibold text-sm">–†–µ–¥–∫–∏—Ö:</p>
                <p class="text-lg font-bold" id="nft-rare-count">0</p>
            </div>
            <div id="nft-legendary-display" class="glass-card p-3 text-center !bg-white/5">
                <p class="text-2xl">üëë</p>
                <p class="font-semibold text-sm">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã—Ö:</p>
                <p class="text-lg font-bold" id="nft-legendary-count">0</p>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" onclick="closeModal()">
        <div class="glass-card p-6 max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-blue-300"></h3>
            <p id="modal-message" class="text-gray-200 mb-4"></p>
            <button onclick="closeModal()" class="w-full glass-button ton-gradient text-white">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

</div>

<script>
    // --- 0. –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
    const WebApp = Telegram.WebApp;
    
    const UPDATE_INTERVAL_MS = 5000; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI (5 —Å–µ–∫—É–Ω–¥)
    const MIN_USD_ACTION = 0.01;
    const YOUTUBE_NFT_LIMIT = 3; 
    const YOUTUBE_NFT_PRICE = 100000; 
    const YOUTUBE_NFT_RATE_INCREASE = 100.00; 

    // 30 –†–ê–ó–ù–´–• –ú–û–î–ï–õ–ï–ô GPU
    const GPUS = [
        // –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
        { id: 'gpu_01', name: 'NVIDIA 1060', price: 10, rate: 0.01, icon: '‚ö°' },
        { id: 'gpu_02', name: 'AMD RX 580', price: 15, rate: 0.015, icon: 'üî•' },
        { id: 'gpu_03', name: 'GTX 1660 Ti', price: 20, rate: 0.02, icon: '‚ú®' },
        { id: 'gpu_04', name: 'RTX 2060', price: 35, rate: 0.035, icon: 'üí®' },
        { id: 'gpu_05', name: 'Radeon 5700 XT', price: 50, rate: 0.05, icon: '‚òÑÔ∏è' },
        { id: 'gpu_06', name: 'RTX 3050', price: 60, rate: 0.06, icon: '‚≠ê' },
        { id: 'gpu_07', name: 'Arc A380', price: 70, rate: 0.07, icon: 'üí°' },
        { id: 'gpu_08', name: 'GTX 1080 Ti', price: 90, rate: 0.09, icon: 'üåü' },
        { id: 'gpu_09', name: 'RTX 3060', price: 120, rate: 0.12, icon: 'üöÄ' },
        { id: 'gpu_10', name: 'Radeon 6600 XT', price: 140, rate: 0.14, icon: 'üí•' },
        
        // –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å
        { id: 'gpu_11', name: 'RTX 3070', price: 200, rate: 0.20, icon: 'üåå' },
        { id: 'gpu_12', name: 'Radeon 6700 XT', price: 220, rate: 0.22, icon: 'üå†' },
        { id: 'gpu_13', name: 'RTX 3070 Ti', price: 250, rate: 0.25, icon: 'üöÅ' },
        { id: 'gpu_14', name: 'Radeon 6800', price: 280, rate: 0.28, icon: 'üõ∞Ô∏è' },
        { id: 'gpu_15', name: 'RTX 3080', price: 350, rate: 0.35, icon: 'üíé' },
        { id: 'gpu_16', name: 'Radeon 6800 XT', price: 380, rate: 0.38, icon: 'üîÆ' },
        { id: 'gpu_17', name: 'RTX 4060', price: 400, rate: 0.40, icon: 'üëë' },
        { id: 'gpu_18', name: 'Radeon 7600 XT', price: 420, rate: 0.42, icon: 'üî±' },
        { id: 'gpu_19', name: 'RTX 4070', price: 550, rate: 0.55, icon: '‚öúÔ∏è' },
        { id: 'gpu_20', name: 'Radeon 7800 XT', price: 600, rate: 0.60, icon: 'üåÄ' },

        // –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
        { id: 'gpu_21', name: 'RTX 3090', price: 700, rate: 0.70, icon: '‚öôÔ∏è' },
        { id: 'gpu_22', name: 'Radeon 7900 XT', price: 800, rate: 0.80, icon: 'üß±' },
        { id: 'gpu_23', name: 'RTX 4080', price: 1000, rate: 1.00, icon: 'üîã' },
        { id: 'gpu_24', name: 'Radeon 7900 XTX', price: 1100, rate: 1.10, icon: 'üå°Ô∏è' },
        { id: 'gpu_25', name: 'RTX 4090', price: 1500, rate: 1.50, icon: '‚ò¢Ô∏è' },
        { id: 'gpu_26', name: 'Tesla V100', price: 2000, rate: 2.00, icon: 'üõ∞' },
        { id: 'gpu_27', name: 'H100 HPC', price: 3000, rate: 3.00, icon: 'üß¨' },
        { id: 'gpu_28', name: 'Jupiter SuperCore', price: 5000, rate: 5.00, icon: 'ü™ê' },
        { id: 'gpu_29', name: 'Mars Core X', price: 7500, rate: 7.50, icon: 'üëΩ' },
        { id: 'gpu_30', name: 'Quantum Core Z', price: 10000, rate: 10.00, icon: '‚ôæÔ∏è' },
    ];
    
    // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    const initialGameState = {
        usd: 100.00, // –ù–∞—á–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª 100 USD
        ton: 0.0000,
        asicCount: 0,
        nftRareCount: 0,
        nftLegendaryCount: 0,
        youtubeNftOwned: 0, 
        
        // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞–∂–¥–æ–π –∫—É–ø–ª–µ–Ω–Ω–æ–π GPU (id: count)
        gpuOwned: {}, 
        
        miningRatePerMin: 0.00, 
        inGameTonPrice: 15.00,
        lastActiveTime: Date.now(),
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ë–∞–Ω–∫–∞
        depositAmount: 0.00,
        bankInterestRate: 5.00, 
        lastInterestCalculationTime: Date.now(),
        accumulatedInterest: 0.00, 
    };

    let gameState = null;
    let pendingPassiveTon = 0; 
    let currentTab = 'farm';

    // --- 1. –§–£–ù–ö–¶–ò–ò FIREBASE (CRUD) ---

    function getUserDocRef(userId) {
        if (!window.firebase.db) return null;
        // –ü—É—Ç—å: /artifacts/{appId}/users/{userId}/gameData/state
        const firestore = window.firebase.db;
        const appId = window.firebase.appId;
        const userPath = `artifacts/${appId}/users/${userId}/gameData/state`;
        return doc(firestore, userPath);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –æ–±—â–µ–π —Å—Ç–∞–≤–∫–∏ –º–∞–π–Ω–∏–Ω–≥–∞
    function calculateTotalMiningRate() {
        let totalRate = 0;

        // 1. ASICs
        totalRate += gameState.asicCount * 0.25;

        // 2. NFTs
        totalRate += gameState.nftRareCount * 0.50;
        totalRate += gameState.nftLegendaryCount * 2.00;
        totalRate += gameState.youtubeNftOwned * YOUTUBE_NFT_RATE_INCREASE;

        // 3. GPUs (–ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ –≤—Å–µ–º –∫—É–ø–ª–µ–Ω–Ω—ã–º –º–æ–¥–µ–ª—è–º)
        for (const gpuId in gameState.gpuOwned) {
            const count = gameState.gpuOwned[gpuId];
            if (count > 0) {
                const gpuInfo = GPUS.find(g => g.id === gpuId);
                if (gpuInfo) {
                    totalRate += count * gpuInfo.rate;
                }
            }
        }
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å
        gameState.miningRatePerMin = parseFloat(totalRate.toFixed(4));
    }


    async function saveState() {
        if (!window.firebase.userIsReady || !gameState || !window.firebase.db) return;
        
        try {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞–≤–∫—É –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
            calculateTotalMiningRate(); 
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
            gameState.lastActiveTime = Date.now();
            
            const userRef = getUserDocRef(window.firebase.userId);
            
            // –ö–ª–æ–Ω–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ —Å –ø–ª–∞–≤–∞—é—â–µ–π –∑–∞–ø—è—Ç–æ–π –≤ Firestore
            const stateToSave = { ...gameState };
            stateToSave.ton = parseFloat(stateToSave.ton.toFixed(8)); 
            stateToSave.usd = parseFloat(stateToSave.usd.toFixed(4)); 
            stateToSave.depositAmount = parseFloat(stateToSave.depositAmount.toFixed(4));
            stateToSave.accumulatedInterest = parseFloat(stateToSave.accumulatedInterest.toFixed(8));
            
            await setDoc(userRef, stateToSave, { merge: true });
        } catch (e) {
            console.error("FIREBASE SAVE ERROR:", e);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    function loadAndSubscribeToState() {
        if (!window.firebase.userIsReady || !window.firebase.db) {
             console.warn("Firebase not ready or db not initialized for subscription.");
             return;
        }
        
        const userRef = getUserDocRef(window.firebase.userId);
        
        // onSnapshot - —Å–ª—É—à–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –æ–±–Ω–æ–≤–ª—è–µ—Ç UI –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        onSnapshot(userRef, (docSnap) => {
            if (docSnap.exists()) {
                const loadedState = docSnap.data();
                // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–≤–º–µ—â–∞–µ–º —Å –Ω–∞—á–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è
                gameState = { ...initialGameState, ...loadedState }; 
            } else {
                // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                gameState = { ...initialGameState };
            }
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ (–≤–∞–∂–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
            calculateTotalMiningRate(); 
            updateGameMetrics(true); // –û–±–Ω–æ–≤–ª—è–µ–º UI –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥/–ø—Ä–æ—Ü–µ–Ω—Ç—ã
            updateUI();
        }, (error) => {
            console.error("FIREBASE LISTEN ERROR:", error);
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            gameState = { ...initialGameState };
            calculateTotalMiningRate();
            updateUI();
        });
    }

    // --- 2. –õ–û–ì–ò–ö–ê –ü–ê–°–°–ò–í–ù–û–ì–û –î–û–•–û–î–ê, –ü–†–û–¶–ï–ù–¢–û–í –ò –°–ë–û–†–ê ---
    
    function updateGameMetrics(isInitialLoad = false) {
        if (!gameState) return;

        const now = Date.now();
        
        // --- –†–∞—Å—á–µ—Ç –ú–∞–π–Ω–∏–Ω–≥–∞ TON ---
        const lastActive = gameState.lastActiveTime || now; 
        const diffMsMining = now - lastActive;
        const diffMinutes = diffMsMining / (1000 * 60);

        const earnedTon = diffMinutes * gameState.miningRatePerMin;
        
        // --- –†–∞—Å—á–µ—Ç –ë–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –ü—Ä–æ—Ü–µ–Ω—Ç–æ–≤ ---
        const lastInterestTime = gameState.lastInterestCalculationTime || now;
        const diffMsInterest = now - lastInterestTime;
        const diffHours = diffMsInterest / (1000 * 60 * 60);

        let interestEarned = 0;
        // –ù–∞—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–µ–ª –æ—â—É—Ç–∏–º—ã–π –ø–µ—Ä–∏–æ–¥ –∏ –µ—Å—Ç—å –¥–µ–ø–æ–∑–∏—Ç
        if (gameState.depositAmount > 0 && diffHours >= 0.0001) { 
            const hourlyRate = gameState.bankInterestRate / 100;
            interestEarned = gameState.depositAmount * hourlyRate * diffHours;
            gameState.accumulatedInterest += interestEarned;
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞–ª—å–∫—É–ª—è—Ü–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
            gameState.lastInterestCalculationTime = now; 
        }

        if (isInitialLoad) {
            // –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤–µ—Å—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –¥–æ—Ö–æ–¥
            pendingPassiveTon = earnedTon;
            gameState.lastActiveTime = now;
        } else {
            // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
            pendingPassiveTon += earnedTon;
            gameState.lastActiveTime = now; // –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑
        }

        updateUI();
    }
    
    function collectPassiveIncome() {
        const collectedTon = pendingPassiveTon;
        const collectedInterest = gameState.accumulatedInterest;
        let feedbackMessage = "";
        let collectedSomething = false;

        // Collect TON
        if (collectedTon >= 0.0001) {
            gameState.ton += collectedTon;
            pendingPassiveTon = 0;
            feedbackMessage += `üí∞ +${collectedTon.toFixed(4)} TON —Å–æ–±—Ä–∞–Ω–æ. `;
            collectedSomething = true;
        }
        
        // Collect Interest (add to deposit and reset accumulated)
        if (collectedInterest >= 0.0001) {
            // –ü—Ä–∏ —Å–±–æ—Ä–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤, –æ–Ω–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –¥–µ–ø–æ–∑–∏—Ç—É
            gameState.depositAmount += collectedInterest;
            gameState.accumulatedInterest = 0.00;
            feedbackMessage += `üí∏ +${collectedInterest.toFixed(4)} $ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –∑–∞—á–∏—Å–ª–µ–Ω–æ –Ω–∞ –≤–∫–ª–∞–¥. `;
            collectedSomething = true;
        }
        
        if (!collectedSomething) {
             showModal("–°–±–æ—Ä –¥–æ—Ö–æ–¥–∞", "‚ùå –ù–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞ (–Ω–∏ TON, –Ω–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤).");
             return;
        }

        saveState();
        updateUI();
        
        // –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        const feedback = document.getElementById('mining-feedback');
        feedback.textContent = feedbackMessage.trim();
        feedback.classList.remove('hidden', 'bg-red-900/50', 'text-red-300');
        feedback.classList.add('bg-green-900/50', 'text-green-300');
        setTimeout(() => feedback.classList.add('hidden'), 5000);
    }

    // --- 3. –õ–û–ì–ò–ö–ê –ë–ê–ù–ö–ê, –ö–û–®–ï–õ–¨–ö–ê –ò –û–ë–ú–ï–ù–ê ---

    function bankDeposit(amount) {
        const bankFeedback = document.getElementById('bank-feedback');
        bankFeedback.classList.add('hidden');
        
        let depositAmount = amount === 'all' ? gameState.usd : amount;
        depositAmount = parseFloat(depositAmount.toFixed(4));

        if (depositAmount < MIN_USD_ACTION || gameState.usd < depositAmount) {
            showFeedback(bankFeedback, `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ USD –∏–ª–∏ —Å—É–º–º–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª–∞ (–º–∏–Ω. ${MIN_USD_ACTION} $).`, 'error');
            return;
        }
        
        gameState.usd -= depositAmount;
        gameState.depositAmount += depositAmount;
        
        saveState();
        updateUI();
        showFeedback(bankFeedback, `‚úÖ ${depositAmount.toFixed(2)} $ —É—Å–ø–µ—à–Ω–æ –≤–Ω–µ—Å–µ–Ω—ã –Ω–∞ –≤–∫–ª–∞–¥.`, 'success');
    }

    function bankWithdraw(amount) {
        const bankFeedback = document.getElementById('bank-feedback');
        bankFeedback.classList.add('hidden');
        
        let withdrawAmount = amount === 'all' ? gameState.depositAmount : amount;
        withdrawAmount = parseFloat(withdrawAmount.toFixed(4));
        
        if (withdrawAmount < MIN_USD_ACTION || gameState.depositAmount < withdrawAmount) {
            showFeedback(bankFeedback, `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –≤–∫–ª–∞–¥–µ –∏–ª–∏ —Å—É–º–º–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª–∞ (–º–∏–Ω. ${MIN_USD_ACTION} $).`, 'error');
            return;
        }
        
        gameState.depositAmount -= withdrawAmount;
        gameState.usd += withdrawAmount;

        saveState();
        updateUI();
        showFeedback(bankFeedback, `‚úÖ ${withdrawAmount.toFixed(2)} $ —É—Å–ø–µ—à–Ω–æ —Å–Ω—è—Ç—ã —Å–æ –≤–∫–ª–∞–¥–∞.`, 'success');
    }
    
    function upgradeInterest() {
        const bankFeedback = document.getElementById('bank-feedback');
        bankFeedback.classList.add('hidden');
        const upgradeCost = 500;
        const rateIncrease = 2.00;

        if (gameState.usd < upgradeCost) {
            showFeedback(bankFeedback, `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ USD. –°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è: ${upgradeCost} $.`, 'error');
            return;
        }
        
        gameState.usd -= upgradeCost;
        gameState.bankInterestRate += rateIncrease;
        
        saveState();
        updateUI();
        showFeedback(bankFeedback, `üöÄ –ü—Ä–æ—Ü–µ–Ω—Ç—ã —É–ª—É—á—à–µ–Ω—ã! –¢–µ–ø–µ—Ä—å —Å—Ç–∞–≤–∫–∞: ${gameState.bankInterestRate.toFixed(2)}% –≤ —á–∞—Å.`, 'success');
    }
    
    function sendMoney() {
        const walletFeedback = document.getElementById('wallet-feedback');
        walletFeedback.classList.add('hidden');
        
        const recipientId = document.getElementById('recipient-id').value.trim();
        const amountInput = document.getElementById('transfer-amount').value;
        const amount = parseFloat(amountInput);

        if (!recipientId) {
            showFeedback(walletFeedback, "‚ùå –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è.", 'error');
            return;
        }
        
        if (isNaN(amount) || amount < MIN_USD_ACTION) {
            showFeedback(walletFeedback, `‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (–º–∏–Ω. ${MIN_USD_ACTION} $).`, 'error');
            return;
        }

        if (amount > gameState.usd) {
            showFeedback(walletFeedback, "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ USD-–±–∞–ª–∞–Ω—Å–µ.", 'error');
            return;
        }
        
        if (recipientId === window.firebase.userId) {
            showFeedback(walletFeedback, "‚ùå –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–µ–Ω—å–≥–∏ —Å–∞–º–æ–º—É —Å–µ–±–µ!", 'error');
            return;
        }

        // --- –°–ò–ú–£–õ–Ø–¶–ò–Ø –ü–ï–†–ï–í–û–î–ê ---
        gameState.usd -= amount;
        
        document.getElementById('recipient-id').value = '';
        document.getElementById('transfer-amount').value = '';

        saveState();
        updateUI();
        showModal("–ü–µ—Ä–µ–≤–æ–¥ —É—Å–ø–µ—à–µ–Ω", `‚úÖ ${amount.toFixed(2)} $ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${recipientId} (—Å–∏–º—É–ª—è—Ü–∏—è).`);
    }
    
    function copyUserId() {
        const userId = window.firebase.userId || '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
        try {
            const tempInput = document.createElement('input');
            tempInput.value = userId;
            document.body.appendChild(tempInput);
            tempInput.select();
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º execCommand –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤ iframe
            document.execCommand('copy'); 
            document.body.removeChild(tempInput);
            showModal("ID –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω", `–í–∞—à ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (${userId}) —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.`);
        } catch (err) {
            showModal("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.");
        }
    }

    function exchangeTonToUsd() {
        const tonPrice = gameState.inGameTonPrice;
        
        if (gameState.ton >= 0.0001) {
            const soldTon = gameState.ton;
            const exchangedUsd = soldTon * tonPrice;
            
            gameState.ton = 0; 
            gameState.usd += exchangedUsd;
            
            // –î–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω—ã: –ø—Ä–æ–¥–∞–∂–∞ TON –ø–æ–Ω–∏–∂–∞–µ—Ç –∫—É—Ä—Å
            gameState.inGameTonPrice -= 0.10;
            if (gameState.inGameTonPrice < 1.0) gameState.inGameTonPrice = 1.0; 
            gameState.inGameTonPrice = parseFloat(gameState.inGameTonPrice.toFixed(2));
            
            saveState();
            updateUI();

            showModal("–û–±–º–µ–Ω —É—Å–ø–µ—à–µ–Ω", `‚úÖ –í—ã –ø—Ä–æ–¥–∞–ª–∏ ${soldTon.toFixed(4)} TON –ø–æ –∫—É—Ä—Å—É $${tonPrice.toFixed(2)} –∏ –ø–æ–ª—É—á–∏–ª–∏ ${exchangedUsd.toFixed(2)} USD.`);
        } else {
            showModal("–û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞", "‚ùå –£ –≤–∞—Å —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ TON –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ (–º–∏–Ω. 0.0001).");
        }
    }

    // --- 4. –õ–û–ì–ò–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê –ò NFT ---
    
    // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫—É–ø–∫–∏ –¥–ª—è 30 GPU
    function buyGpu(gpuId) {
        const gpuInfo = GPUS.find(g => g.id === gpuId);
        const shopFeedback = document.getElementById('shop-feedback');
        shopFeedback.classList.add('hidden');
        
        if (!gpuInfo) return;

        const price = gpuInfo.price;
        const rateIncrease = gpuInfo.rate;
        
        if (gameState.usd >= price) {
            
            gameState.usd -= price;
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —ç—Ç–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π GPU
            gameState.gpuOwned[gpuId] = (gameState.gpuOwned[gpuId] || 0) + 1;
            
            // –î–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω—ã: –ø–æ–∫—É–ø–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ–≤—ã—à–∞–µ—Ç —Å–ø—Ä–æ—Å –∏ —Ü–µ–Ω—É –Ω–∞ TON
            gameState.inGameTonPrice += 0.05;
            gameState.inGameTonPrice = parseFloat(gameState.inGameTonPrice.toFixed(2));
            
            saveState(); // –°–æ—Ö—Ä–∞–Ω–∏—Ç –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –æ–±—â—É—é —Å—Ç–∞–≤–∫—É
            updateUI();
            
            showFeedback(shopFeedback, `‚úÖ –ö—É–ø–ª–µ–Ω–∞ ${gpuInfo.name} (+${rateIncrease.toFixed(2)} TON/–º–∏–Ω)!`, 'success');
            
        } else {
            showFeedback(shopFeedback, `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ ${price} $, —É –≤–∞—Å ${gameState.usd.toFixed(2)} $.`, 'error');
        }
    }

    // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è ASIC
    function buyEquipment(type, price, rateIncrease) {
        const shopFeedback = document.getElementById('shop-feedback');
        shopFeedback.classList.add('hidden');
        
        if (gameState.usd < price) {
             showFeedback(shopFeedback, `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ USD. –°—Ç–æ–∏–º–æ—Å—Ç—å: ${price} $.`, 'error');
             return;
        }
        
        gameState.usd -= price;

        if (type === 'asic') {
            gameState.asicCount += 1;
            gameState.miningRatePerMin += rateIncrease; // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–≤–∫—É ASIC —è–≤–Ω–æ
        }
        
        // –î–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω—ã: –ø–æ–∫—É–ø–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ–≤—ã—à–∞–µ—Ç —Å–ø—Ä–æ—Å –∏ —Ü–µ–Ω—É –Ω–∞ TON
        gameState.inGameTonPrice += 0.05;
        gameState.inGameTonPrice = parseFloat(gameState.inGameTonPrice.toFixed(2));

        saveState(); // –°—Ä–∞–±–æ—Ç–∞–µ—Ç calculateTotalMiningRate –¥–ª—è GPU/NFT, –Ω–æ –¥–ª—è ASIC –Ω—É–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ä–∞–∑—É
        updateUI();
        
        showFeedback(shopFeedback, `‚úÖ –ö—É–ø–ª–µ–Ω ${type === 'asic' ? 'ASIC-–º–∞–π–Ω–µ—Ä' : '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ'}!`, 'success');
    }
    
    function buyYoutubeNft() {
        const price = YOUTUBE_NFT_PRICE;
        const rateIncrease = YOUTUBE_NFT_RATE_INCREASE;
        const nftFeedback = document.getElementById('nft-feedback');
        nftFeedback.classList.add('hidden');

        if (gameState.youtubeNftOwned >= YOUTUBE_NFT_LIMIT) {
            showFeedback(nftFeedback, "‚ùå –í—Å–µ 3 NFT —É–∂–µ –∫—É–ø–ª–µ–Ω—ã! –≠—Ç–æ –ª–∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–¥–∞–Ω–∏–µ.", 'error');
            return;
        }

        if (gameState.usd < price) {
            showFeedback(nftFeedback, `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ USD. –°—Ç–æ–∏–º–æ—Å—Ç—å NFT: ${price.toLocaleString('ru-RU')} $.`, 'error');
            return;
        }

        gameState.usd -= price;
        gameState.youtubeNftOwned += 1;

        saveState(); // –°–æ—Ö—Ä–∞–Ω–∏—Ç –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –æ–±—â—É—é —Å—Ç–∞–≤–∫—É
        updateUI();
        
        const remaining = YOUTUBE_NFT_LIMIT - gameState.youtubeNftOwned;
        showFeedback(nftFeedback, `üéâ –ö—É–ø–ª–µ–Ω YouTube NFT! +${rateIncrease.toFixed(2)} TON/–º–∏–Ω. –û—Å—Ç–∞–ª–æ—Å—å ${remaining} —à—Ç.`, 'success');
    }

    function buyNFTBox() {
        const price = 100;
        const nftFeedback = document.getElementById('nft-feedback');
        nftFeedback.classList.add('hidden');

        if (gameState.usd < price) {
            showFeedback(nftFeedback, `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ USD. –°—Ç–æ–∏–º–æ—Å—Ç—å –±–æ–∫—Å–∞: ${price} $.`, 'error');
            return;
        }
        
        gameState.usd -= price;
        
        const roll = Math.random();
        let rewardType = '';
        
        if (roll < 0.8) {
            gameState.nftRareCount += 1;
            rewardType = '–†–µ–¥–∫–∏–π (+0.5 TON/–º–∏–Ω)';
        } else {
            gameState.nftLegendaryCount += 1;
            rewardType = '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π (+2.0 TON/–º–∏–Ω)';
        }
        
        saveState(); // –°–æ—Ö—Ä–∞–Ω–∏—Ç –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –æ–±—â—É—é —Å—Ç–∞–≤–∫—É
        updateUI();
        
        showFeedback(nftFeedback, `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ NFT: ${rewardType}!`, 'success');
    }
    
    // --- 5. –û–ë–ù–û–í–õ–ï–ù–ò–ï UI –ò –£–¢–ò–õ–ò–¢–´ ---
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ 30 –∫–∞—Ä—Ç–æ—á–µ–∫ GPU
    function renderGpuList() {
        const container = document.getElementById('gpu-list-container');
        if (!container) return;
        
        container.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞
        
        GPUS.forEach(gpu => {
            const ownedCount = gameState.gpuOwned[gpu.id] || 0;
            const card = document.createElement('div');
            // –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
            card.className = 'glass-card p-4 flex flex-col justify-between transition duration-200 text-sm';
            
            const isDisabled = gameState.usd < gpu.price;
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <p class="text-2xl">${gpu.icon}</p>
                    <p class="text-lg font-semibold text-white truncate ml-2">${gpu.name}</p>
                </div>
                <p class="text-xs text-gray-400">–î–æ—Ö–æ–¥: +${gpu.rate.toFixed(2)} TON/–º–∏–Ω</p>
                <p class="text-xs text-gray-400 mb-3">–£ –≤–∞—Å: <span class="font-bold text-cyan-300">${ownedCount}</span> —à—Ç.</p>
                
                <div class="flex justify-between items-center mt-auto">
                    <p class="text-green-400 font-bold text-lg">${gpu.price} $</p>
                    <button 
                        onclick="buyGpu('${gpu.id}')" 
                        class="glass-button ton-gradient text-white text-xs py-2 px-4 ${isDisabled ? 'opacity-30' : ''}"
                        ${isDisabled ? 'disabled' : ''}
                    >
                        –ö—É–ø–∏—Ç—å
                    </button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function updateUI() {
        if (!gameState) return;

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ---
        document.getElementById('display-usd').textContent = gameState.usd.toFixed(2);
        document.getElementById('display-ton').textContent = gameState.ton.toFixed(4);
        document.getElementById('display-ton-price').textContent = gameState.inGameTonPrice.toFixed(2);
        document.getElementById('profile-id').textContent = window.firebase.userId || '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
        document.getElementById('passive-rate').textContent = gameState.miningRatePerMin.toFixed(2) + ' TON/–º–∏–Ω';
        document.getElementById('current-exchange-rate').textContent = gameState.inGameTonPrice.toFixed(2);


        // --- –§–µ—Ä–º–∞ (–°–±–æ—Ä) ---
        const pendingDisplay = document.getElementById('pending-ton');
        const collectBtn = document.getElementById('collect-button');
        
        pendingDisplay.textContent = pendingPassiveTon.toFixed(4) + ' TON';
        const collectedInterest = gameState.accumulatedInterest;
        
        if (pendingPassiveTon >= 0.0001 || collectedInterest >= 0.0001) {
            collectBtn.disabled = false;
        } else {
            collectBtn.disabled = true;
        }
        
        // --- –ú–∞–≥–∞–∑–∏–Ω (–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ 30 GPU –∏ ASIC) ---
        if (currentTab === 'shop') {
            renderGpuList(); // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ GPU
            document.getElementById('asic-count').textContent = gameState.asicCount;
            document.getElementById('buy-asic-button').disabled = gameState.usd < 500;
        }
        
        // --- NFT ---
        document.getElementById('nft-rare-count').textContent = gameState.nftRareCount;
        document.getElementById('nft-legendary-count').textContent = gameState.nftLegendaryCount;
        
        // --- YouTube NFT ---
        const stockDisplay = document.getElementById('youtube-nft-stock');
        const ownedDisplay = document.getElementById('youtube-nft-owned');
        const buyYoutubeBtn = document.getElementById('buy-youtube-nft-button');
        
        const remainingStock = YOUTUBE_NFT_LIMIT - gameState.youtubeNftOwned; // –°–∏–º—É–ª—è—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞
        stockDisplay.textContent = remainingStock;
        ownedDisplay.textContent = gameState.youtubeNftOwned;

        if (gameState.youtubeNftOwned >= YOUTUBE_NFT_LIMIT) {
            buyYoutubeBtn.disabled = true;
            buyYoutubeBtn.textContent = '–ü–†–û–î–ê–ù–û';
        } else {
            buyYoutubeBtn.disabled = gameState.usd < YOUTUBE_NFT_PRICE;
            buyYoutubeBtn.textContent = '–ö—É–ø–∏—Ç—å NFT';
        }
        document.getElementById('buy-nft-button').disabled = gameState.usd < 100;
        
        // --- –û–±–º–µ–Ω ---
        const exchangeBtn = document.getElementById('exchange-button');
        exchangeBtn.disabled = gameState.ton < 0.0001;
        
        // --- –ë–∞–Ω–∫ ---
        document.getElementById('bank-usd-balance').textContent = gameState.usd.toFixed(4);
        document.getElementById('bank-deposit-amount').textContent = gameState.depositAmount.toFixed(4);
        document.getElementById('bank-interest-rate').textContent = gameState.bankInterestRate.toFixed(2) + '%';
        document.getElementById('bank-accumulated-interest').textContent = gameState.accumulatedInterest.toFixed(4);
        document.getElementById('current-interest-rate-upgrade').textContent = gameState.bankInterestRate.toFixed(2);

        // –ö–Ω–æ–ø–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–∞/—Å–Ω—è—Ç–∏—è
        document.getElementById('deposit-100-btn').disabled = gameState.usd < 100;
        document.getElementById('withdraw-100-btn').disabled = gameState.depositAmount < 100;
        document.getElementById('deposit-all-btn').disabled = gameState.usd < MIN_USD_ACTION;
        document.getElementById('withdraw-all-btn').disabled = gameState.depositAmount < MIN_USD_ACTION;
        document.getElementById('upgrade-interest-btn').disabled = gameState.usd < 500;
        
        // --- –ö–æ—à–µ–ª–µ–∫ ---
        document.getElementById('wallet-usd-balance').textContent = gameState.usd.toFixed(4);
        document.getElementById('wallet-user-id').textContent = window.firebase.userId || '–û–∂–∏–¥–∞–Ω–∏–µ ID...';
        document.getElementById('send-money-btn').disabled = gameState.usd < MIN_USD_ACTION;
    }
    
    function changeTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`content-${tabName}`).classList.remove('hidden');
        document.getElementById(`tab-${tabName}`).classList.add('active');
        currentTab = tabName;
        
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –ú–∞–≥–∞–∑–∏–Ω
        if (tabName === 'shop') {
            renderGpuList();
        }

        updateUI(); 
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    function showModal(title, message) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').innerHTML = message;
        document.getElementById('modal').classList.remove('hidden');
    }
    
    function closeModal() {
        document.getElementById('modal').classList.add('hidden');
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –≤ —Ä–∞–∑–¥–µ–ª–∞—Ö
    function showFeedback(element, message, type) {
        element.textContent = message;
        element.classList.remove('hidden', 'bg-red-900/50', 'text-red-300', 'bg-green-900/50', 'text-green-300');
        
        if (type === 'success') {
            element.classList.add('bg-green-900/50', 'text-green-300');
        } else if (type === 'error') {
            element.classList.add('bg-red-900/50', 'text-red-300');
        }
        element.classList.remove('hidden');
        setTimeout(() => element.classList.add('hidden'), 4000);
    }

    // --- 6. –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---

    // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase
    window.onFirebaseReady = function() {
        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        loadAndSubscribeToState();
        
        // 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        setInterval(() => {
            updateGameMetrics(); 
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–±–æ—Ä–µ/–ø–æ–∫—É–ø–∫–µ/–±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
        }, UPDATE_INTERVAL_MS);

        // 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI Telegram (–¥–ª—è –ª—É—á—à–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
        WebApp.ready(); 
        WebApp.setBackgroundColor('#0b0f19');
        WebApp.setHeaderColor('#0b0f19');
        
        // 4. –°–∫—Ä—ã—Ç–∏–µ —ç–∫—Ä–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–∫–∞–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        document.getElementById('loading-overlay').classList.add('hidden');
        
        // 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
        changeTab(currentTab);
        
        // 6. –ü–µ—Ä–≤–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI 
        if (!gameState) updateUI();
    };

    // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    document.addEventListener('DOMContentLoaded', () => {
         // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ Firebase —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è (–æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ)
         if (window.firebase.userIsReady) {
             window.onFirebaseReady();
         }
    });

</script>

</body>
</html>
