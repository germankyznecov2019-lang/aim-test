<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Eye Gaze Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #000; height: 100vh; overflow: hidden; font-family: system-ui, sans-serif; display: flex; justify-content: center; align-items: center; }
        
        .camera-view { position: relative; width: 100%; height: 100%; }
        
        video {
            position: absolute; width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(-1); /* –ó–µ—Ä–∫–∞–ª–∏–º –¥–ª—è —Å–µ–ª—Ñ–∏ */
        }
        
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 40px 20px;
        }

        .status-badge {
            align-self: center;
            background: rgba(20, 0, 0, 0.6);
            border: 1px solid rgba(255, 50, 50, 0.3);
            color: #ff4444;
            padding: 8px 16px; border-radius: 20px;
            font-weight: bold; font-size: 14px;
            backdrop-filter: blur(10px);
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.2);
        }
        
        .status-dot { width: 8px; height: 8px; background: #ff4444; border-radius: 50%; box-shadow: 0 0 10px #ff0000; }

        .controls {
            pointer-events: auto;
            display: flex; justify-content: center; gap: 30px; margin-bottom: 20px;
        }

        .btn {
            width: 70px; height: 70px; border-radius: 50%; border: none;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.25); }
        
        .btn-rec.recording {
            background: rgba(255, 0, 0, 0.3); border-color: red; color: red;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255,0,0,0.4);} 70% {box-shadow: 0 0 0 15px rgba(255,0,0,0);} 100% {box-shadow: 0 0 0 0 rgba(255,0,0,0);} }

        #loader {
            position: absolute; z-index: 99; background: #000; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; gap: 15px;
        }
    </style>
</head>
<body>

    <div id="loader">
        <div style="width: 30px; height: 30px; border: 3px solid #333; border-top: 3px solid red; border-radius: 50%; animation: spin 1s infinite linear;"></div>
        <span>–ó–∞–≥—Ä—É–∑–∫–∞ –ò–ò...</span>
    </div>

    <div class="camera-view">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        
        <div class="ui-layer">
            <div class="status-badge">
                <div class="status-dot"></div>
                <span id="status-text">SYSTEM INIT</span>
            </div>
            
            <div class="controls">
                <button class="btn" id="btn-photo">üì∑</button>
                <button class="btn btn-rec" id="btn-video">‚≠ï</button>
            </div>
        </div>
    </div>

    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusText = document.getElementById('status-text');
        const loader = document.getElementById('loader');
        
        // –°—Å—ã–ª–∫–∞ –Ω–∞ –º–æ–¥–µ–ª–∏
        const MODELS_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        let isModelLoaded = false;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;

        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π (–î–µ—Ç–µ–∫—Ç–æ—Ä –ª–∏—Ü + –¢–æ—á–∫–∏ –ª–∏—Ü–∞)
        async function loadModels() {
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODELS_URL),
                    faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODELS_URL) // –í–∞–∂–Ω–æ: –º–æ–¥–µ–ª—å —Ç–æ—á–µ–∫ –ª–∏—Ü–∞
                ]);
                isModelLoaded = true;
                startCamera();
            } catch (err) {
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π: " + err);
            }
        }

        // 2. –ö–∞–º–µ—Ä–∞
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç —á–µ—Ä–µ–∑ HTTPS.");
            }
        }

        // 3. –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª
        video.addEventListener('play', () => {
            loader.style.display = 'none';
            statusText.innerText = "SCANNING...";
            
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                if (!isModelLoaded) return;

                // –ò—â–µ–º –ª–∏—Ü–∞ –ò —Ç–æ—á–∫–∏ –Ω–∞ –Ω–∏—Ö
                const detections = await faceapi.detectAllFaces(
                    video, 
                    new faceapi.TinyFaceDetectorOptions()
                ).withFaceLandmarks(true);

                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (resizedDetections.length > 0) {
                    statusText.innerText = "TARGET LOCKED";
                    statusText.style.color = "#ff4444";
                } else {
                    statusText.innerText = "SEARCHING...";
                    statusText.style.color = "white";
                }

                resizedDetections.forEach(det => {
                    // 1. –†–ò–°–£–ï–ú –ë–û–õ–¨–®–û–ô –ö–†–£–ì –í–û–ö–†–£–ì –õ–ò–¶–ê
                    drawFaceCircle(ctx, det.detection.box);

                    // 2. –ü–û–õ–£–ß–ê–ï–ú –ö–û–û–†–î–ò–ù–ê–¢–´ –ì–õ–ê–ó
                    const landmarks = det.landmarks;
                    const leftEye = landmarks.getLeftEye();
                    const rightEye = landmarks.getRightEye();
                    const nose = landmarks.getNose();

                    // 3. –†–ò–°–£–ï–ú –ö–†–ê–°–ù–£–Æ –û–ë–í–û–î–ö–£ –ì–õ–ê–ó
                    drawEyeOutline(ctx, leftEye);
                    drawEyeOutline(ctx, rightEye);

                    // 4. –†–ò–°–£–ï–ú –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï –í–ó–ì–õ–Ø–î–ê (–õ–∞–∑–µ—Ä—ã)
                    // –í—ã—á–∏—Å–ª—è–µ–º –≤–µ–∫—Ç–æ—Ä "–∫—É–¥–∞ —Å–º–æ—Ç—Ä–∏—Ç –ª–∏—Ü–æ" –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ—Å–∞
                    // –í–µ—Ä—Ö –Ω–æ—Å–∞ - —Ç–æ—á–∫–∞ 0, –ù–∏–∑ –Ω–æ—Å–∞ - —Ç–æ—á–∫–∞ 4 (–≤ –º–∞—Å—Å–∏–≤–µ –Ω–æ—Å–∞)
                    const noseTop = nose[0];
                    const noseBottom = nose[3]; // –ö–æ–Ω—á–∏–∫ –Ω–æ—Å–∞

                    // –í–µ–∫—Ç–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–æ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏—Ü—ã –∫ –∫–æ–Ω—á–∏–∫—É)
                    const gazeVector = {
                        x: (noseBottom.x - noseTop.x) * 8, // –£—Å–∏–ª–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
                        y: (noseBottom.y - noseTop.y) * 8
                    };

                    drawGaze(ctx, leftEye, gazeVector);
                    drawGaze(ctx, rightEye, gazeVector);
                });

            }, 80); // –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        });

        // --- –§–£–ù–ö–¶–ò–ò –û–¢–†–ò–°–û–í–ö–ò ---

        function drawFaceCircle(ctx, box) {
            // –ó–µ—Ä–∫–∞–ª–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã X, —Ç–∞–∫ –∫–∞–∫ –≤–∏–¥–µ–æ –æ—Ç–∑–µ—Ä–∫–∞–ª–µ–Ω–æ CSS-–æ–º
            // –ù–æ –∫–∞–Ω–≤–∞—Å —Ä–∏—Å—É–µ—Ç –ø—Ä—è–º–æ. –ù—É–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å X —Å–ø—Ä–∞–≤–∞.
            const centerX = canvas.width - (box.x + box.width / 2);
            const centerY = box.y + box.height / 2;
            const radius = box.width / 1.6;

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.lineWidth = 3;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.shadowColor = '#00ffcc';
            ctx.shadowBlur = 15;
            ctx.stroke();
        }

        function drawEyeOutline(ctx, points) {
            ctx.beginPath();
            // –ó–µ—Ä–∫–∞–ª–∏–º –∫–∞–∂–¥—É—é —Ç–æ—á–∫—É –≥–ª–∞–∑–∞
            const firstX = canvas.width - points[0].x;
            ctx.moveTo(firstX, points[0].y);
            
            for (let i = 1; i < points.length; i++) {
                const x = canvas.width - points[i].x;
                ctx.lineTo(x, points[i].y);
            }
            ctx.closePath();
            
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#ff0000'; // –ö—Ä–∞—Å–Ω—ã–π
            ctx.shadowColor = '#ff0000';
            ctx.shadowBlur = 10;
            ctx.stroke();
        }

        function drawGaze(ctx, eyePoints, vector) {
            // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–Ω—Ç—Ä –≥–ª–∞–∑–∞
            let sumX = 0, sumY = 0;
            eyePoints.forEach(p => { sumX += p.x; sumY += p.y; });
            
            const centerX = canvas.width - (sumX / eyePoints.length); // –ó–µ—Ä–∫–∞–ª–∏–º —Ü–µ–Ω—Ç—Ä
            const centerY = sumY / eyePoints.length;

            // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –≤–∑–≥–ª—è–¥–∞
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            // –õ–∏–Ω–∏—è –∏–¥–µ—Ç –û–¢ —Ü–µ–Ω—Ç—Ä–∞ –ü–õ–Æ–° –≤–µ–∫—Ç–æ—Ä
            // –í–∞–∂–Ω–æ: vector.x –Ω—É–∂–Ω–æ –≤—ã—á–∏—Ç–∞—Ç—å, —Ç.–∫. –º—ã –≤ –∑–µ—Ä–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
            ctx.lineTo(centerX - vector.x, centerY + vector.y);
            
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'rgba(255, 50, 50, 0.6)'; // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –ª—É—á
            ctx.stroke();
            
            // –¢–æ—á–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–ª–∞–∑–∞
            ctx.beginPath();
            ctx.arc(centerX, centerY, 3, 0, Math.PI*2);
            ctx.fillStyle = 'red';
            ctx.fill();
        }
        
        // --- –ó–ê–ü–ò–°–¨ –ò –§–û–¢–û ---

        document.getElementById('btn-photo').onclick = () => {
            const link = document.createElement('a');
            link.download = 'cyber-face.png';
            link.href = canvas.toDataURL();
            link.click();
        };

        const btnVideo = document.getElementById('btn-video');
        btnVideo.onclick = () => {
            if (isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                btnVideo.classList.remove('recording');
            } else {
                const stream = canvas.captureStream(30);
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                recordedChunks = [];
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'cyber-video.webm'; a.click();
                };
                mediaRecorder.start();
                isRecording = true;
                btnVideo.classList.add('recording');
            }
        };
        
        // –°—Ç–∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        const style = document.createElement('style');
        style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
        document.head.appendChild(style);

        // –°—Ç–∞—Ä—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            if(typeof faceapi !== 'undefined') loadModels();
            else alert("–û—à–∏–±–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ face-api");
        };

    </script>
</body>
</html>
