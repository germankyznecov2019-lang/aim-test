<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Face & Body AR</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #000; height: 100vh; overflow: hidden; font-family: system-ui, sans-serif; display: flex; justify-content: center; align-items: center; }
        
        .camera-container { position: relative; width: 100%; height: 100%; }
        
        video {
            position: absolute; width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.5s;
        }
        
        /* Зеркалирование только для селфи */
        video.mirrored { transform: scaleX(-1); }
        
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Интерфейс */
        .ui-layer {
            position: absolute; bottom: 40px; left: 0; width: 100%;
            display: flex; justify-content: center; align-items: center; gap: 30px;
            pointer-events: none; z-index: 10;
        }

        .btn {
            pointer-events: auto;
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: 0.3s; cursor: pointer;
        }
        .btn:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.2); }
        .btn svg { width: 26px; height: 26px; fill: currentColor; }

        /* Кнопка смены режима (Face/Body) */
        .btn-mode {
            width: 75px; height: 75px; /* Чуть больше */
            border-color: #00ffcc; color: #00ffcc;
            background: rgba(0, 255, 204, 0.1);
        }
        .btn-mode.body-active {
            border-color: #ff0000; color: #ff0000;
            background: rgba(255, 0, 0, 0.15);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.4);
        }

        /* Активная кнопка фонарика */
        .btn.active {
            background: rgba(255, 200, 0, 0.2); border-color: #ffcc00; color: #ffcc00;
            box-shadow: 0 0 20px rgba(255, 200, 0, 0.4);
        }
        .btn:disabled { opacity: 0.3; filter: grayscale(1); }

        /* Загрузчик */
        #loader {
            position: absolute; top:0; left:0; width: 100%; height: 100%; background: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99;
            color: #888; gap: 15px; transition: opacity 0.5s;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #00ffcc; border-radius: 50%;
            animation: spin 1s infinite linear;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .status-text {
            position: absolute; top: 120px; width: 100%; text-align: center;
            color: rgba(255,255,255,0.7); font-size: 14px; text-shadow: 0 1px 3px black;
        }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <span id="loader-text">Загрузка Face AI...</span>
    </div>

    <div class="camera-container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        <div class="status-text" id="status-text"></div>
        
        <div class="ui-layer">
            <button class="btn" id="btn-torch" disabled>
                <svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>
            </button>

            <button class="btn btn-mode" id="btn-mode">
                <svg id="icon-face" viewBox="0 0 24 24"><path d="M9 11.75c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zm6 0c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-.29.02-.58.05-.86 2.36-1.05 4.23-2.98 5.21-5.37C11.07 8.33 14.05 10 17.42 10c.78 0 1.53-.09 2.25-.26.21 1.17.33 2.3.33 3.26 0 3.86-3.59 7-8 7z"/></svg>
                <svg id="icon-body" style="display:none" viewBox="0 0 24 24"><path d="M12 2c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm9 7h-6v13h-2v-6h-2v6H9V9H3V7h18v2z"/></svg>
            </button>

            <button class="btn" id="btn-flip">
                <svg viewBox="0 0 24 24"><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5V13H9v2.5L5.5 12 9 8.5V11h6V8.5l3.5 3.5-3.5 3.5z"/></svg>
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const statusText = document.getElementById('status-text');
        
        const btnMode = document.getElementById('btn-mode');
        const iconFace = document.getElementById('icon-face');
        const iconBody = document.getElementById('icon-body');
        
        const btnFlip = document.getElementById('btn-flip');
        const btnTorch = document.getElementById('btn-torch');

        // Состояние
        let currentMode = 'face'; // 'face' или 'body'
        let currentFacingMode = 'user';
        let isTorchOn = false;
        let stream = null;
        
        // Статусы моделей
        let isFaceModelLoaded = false;
        let faceModels = null;
        let bodyModel = null;
        
        // URL
        const FACE_MODELS_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        // 1. Инициализация (загружаем только Face сначала)
        async function init() {
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(FACE_MODELS_URL),
                    faceapi.nets.faceLandmark68TinyNet.loadFromUri(FACE_MODELS_URL)
                ]);
                isFaceModelLoaded = true;
                loader.style.display = 'none';
                startCamera();
            } catch (err) {
                alert("Ошибка загрузки Face API: " + err);
            }
        }

        // 2. Камера
        async function startCamera() {
            if (stream) stream.getTracks().forEach(track => track.stop());
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode, width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
                
                // Настройка UI
                if (currentFacingMode === 'user') {
                    video.classList.add('mirrored');
                    btnTorch.disabled = true;
                } else {
                    video.classList.remove('mirrored');
                    btnTorch.disabled = false;
                }
            } catch (err) {
                console.error(err);
                alert("Нет доступа к камере");
            }
        }

        // 3. Логика отрисовки
        video.addEventListener('play', () => {
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            // Единый цикл
            setInterval(async () => {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (video.paused || video.ended) return;

                // --- РЕЖИМ ЛИЦА ---
                if (currentMode === 'face' && isFaceModelLoaded) {
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true);
                    
                    // Обновляем размер при ресайзе
                    const dims = faceapi.matchDimensions(canvas, video, true);
                    const resizedDetections = faceapi.resizeResults(detections, dims);

                    resizedDetections.forEach(det => {
                        const box = det.detection.box;
                        const landmarks = det.landmarks;
                        
                        let centerX, centerY, radius;
                        
                        if (currentFacingMode === 'user') {
                            // Зеркально
                            centerX = canvas.width - (box.x + box.width/2);
                            drawFaceUI(ctx, centerX, box.y + box.height/2, box.width/1.6, landmarks, true);
                        } else {
                            // Нормально
                            centerX = box.x + box.width/2;
                            drawFaceUI(ctx, centerX, box.y + box.height/2, box.width/1.6, landmarks, false);
                        }
                    });
                }

                // --- РЕЖИМ ТЕЛА ---
                if (currentMode === 'body' && bodyModel) {
                    const predictions = await bodyModel.detect(video);
                    
                    predictions.forEach(prediction => {
                        if (prediction.class === 'person') {
                            const [x, y, width, height] = prediction.bbox;
                            
                            // Рисуем КРАСНУЮ рамку
                            ctx.lineWidth = 4;
                            ctx.strokeStyle = '#ff0000';
                            ctx.shadowColor = '#ff0000';
                            ctx.shadowBlur = 20;

                            // Скругляем углы рамки для стиля
                            roundRect(ctx, x, y, width, height, 20);
                            ctx.stroke();

                            // Текст
                            ctx.font = "bold 16px Arial";
                            ctx.fillStyle = '#ff0000';
                            ctx.fillText(`HUMAN ${Math.round(prediction.score*100)}%`, x + 10, y + 25);
                        }
                    });
                }

            }, 100);
        });

        // --- Переключение режима ---
        btnMode.addEventListener('click', async () => {
            if (currentMode === 'face') {
                // Переключаем на BODY
                currentMode = 'body';
                btnMode.classList.add('body-active');
                iconFace.style.display = 'none';
                iconBody.style.display = 'block';
                statusText.innerText = "Загрузка Body AI...";
                
                // Если модель тела еще не загружена, грузим
                if (!bodyModel) {
                    loader.style.display = 'flex';
                    loaderText.innerText = "Калибровка сканера тела...";
                    try {
                        bodyModel = await cocoSsd.load({ base: 'lite_mobilenet_v2' }); // Lite версия
                    } catch(e) {
                        alert("Ошибка загрузки Body AI");
                        currentMode = 'face'; // Возврат при ошибке
                    }
                    loader.style.display = 'none';
                }
                statusText.innerText = "";

            } else {
                // Переключаем обратно на FACE
                currentMode = 'face';
                btnMode.classList.remove('body-active');
                iconFace.style.display = 'block';
                iconBody.style.display = 'none';
            }
        });

        // --- Вспомогательные функции рисования ---
        
        function drawFaceUI(ctx, x, y, r, landmarks, isMirrored) {
            // Круг
            ctx.beginPath();
            ctx.arc(x, y, r, 0, 2 * Math.PI);
            ctx.lineWidth = 4;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.shadowColor = '#00ffcc';
            ctx.shadowBlur = 20;
            ctx.stroke();
            
            // Глаза
            drawEye(ctx, landmarks.getLeftEye(), isMirrored);
            drawEye(ctx, landmarks.getRightEye(), isMirrored);
        }

        function drawEye(ctx, points, isMirrored) {
            ctx.beginPath();
            const startX = isMirrored ? canvas.width - points[0].x : points[0].x;
            ctx.moveTo(startX, points[0].y);
            
            for (let i = 1; i < points.length; i++) {
                const px = isMirrored ? canvas.width - points[i].x : points[i].x;
                ctx.lineTo(px, points[i].y);
            }
            ctx.closePath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#ff0000';
            ctx.shadowColor = '#ff0000';
            ctx.shadowBlur = 10;
            ctx.stroke();
        }
        
        // Функция для красивой рамки
        function roundRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
        }

        // --- Кнопки Фонарик и Флип ---
        btnFlip.addEventListener('click', () => {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            startCamera();
        });

        btnTorch.addEventListener('click', async () => {
            if (!stream) return;
            const track = stream.getVideoTracks()[0];
            try {
                isTorchOn = !isTorchOn;
                await track.applyConstraints({ advanced: [{ torch: isTorchOn }] });
                btnTorch.classList.toggle('active', isTorchOn);
            } catch (e) { alert("Фонарик недоступен"); isTorchOn = !isTorchOn; }
        });

        window.onload = init;
    </script>
</body>
</html>
