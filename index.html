<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Симулятор Майнинга TON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            padding: 2rem 1rem;
        }
        .app-container {
            background-color: #2d3748; 
            color: #e2e8f0;
        }
        .gpu-card {
            background-color: #1f2937; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .gpu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.25);
        }
        .button-primary {
            background-color: #48bb78; 
            color: #1a202c;
        }
        .button-primary:hover {
            background-color: #68d391;
        }
        .tab-active {
            border-bottom: 2px solid #48bb78; 
            color: #48bb78; 
            font-weight: bold;
        }
        /* Style for the quantity input */
        .quantity-input {
            -moz-appearance: textfield;
        }
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .input-base {
            background-color: #1f2937;
            border: 1px solid #4a5568;
            color: #e2e8f0;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: border-color 0.2s;
        }
        .input-base:focus {
            border-color: #63b3ed;
            outline: none;
        }
    </style>
</head>
<body>

    <div id="app" class="w-full max-w-7xl mx-auto p-6 app-container shadow-2xl rounded-xl border border-gray-600">
        
        <!-- User ID Display (Crucial for collaboration/transfers) -->
        <div class="mb-4 text-xs text-right text-gray-500">
            Ваш ID для переводов: <span id="currentUserId" class="font-mono text-gray-300 select-all cursor-pointer">Загрузка...</span>
        </div>

        <!-- Navigation Sections -->
        <nav class="flex space-x-2 sm:space-x-6 border-b border-gray-700 mb-8">
            <button id="navProfile" 
                    onclick="showSection('profile')" 
                    class="px-2 sm:px-4 py-2 text-gray-400 text-sm sm:text-base font-medium cursor-pointer transition duration-150 ease-in-out hover:text-gray-200 tab-active">
                Профиль
            </button>
            <button id="navMining" 
                    onclick="showSection('mining')" 
                    class="px-2 sm:px-4 py-2 text-gray-400 text-sm sm:text-base font-medium cursor-pointer transition duration-150 ease-in-out hover:text-gray-200">
                Ферма
            </button>
            <button id="navShop" 
                    onclick="showSection('shop')" 
                    class="px-2 sm:px-4 py-2 text-gray-400 text-sm sm:text-base font-medium cursor-pointer transition duration-150 ease-in-out hover:text-gray-200">
                Видеокарты
            </button>
            <button id="navBank" 
                    onclick="showSection('bank')" 
                    class="px-2 sm:px-4 py-2 text-gray-400 text-sm sm:text-base font-medium cursor-pointer transition duration-150 ease-in-out hover:text-gray-200">
                Банк (USD)
            </button>
            <button id="navMarket" 
                    onclick="showSection('market')" 
                    class="px-2 sm:px-4 py-2 text-gray-400 text-sm sm:text-base font-medium cursor-pointer transition duration-150 ease-in-out hover:text-gray-200">
                Рынок TON
            </button>
            <button id="navWallet" 
                    onclick="showSection('wallet')" 
                    class="px-2 sm:px-4 py-2 text-gray-400 text-sm sm:text-base font-medium cursor-pointer transition duration-150 ease-in-out hover:text-gray-200">
                Кошелек
            </button>
        </nav>
        <!-- End Navigation Sections -->
        
        <!-- ========================================================================= -->
        <!-- 6. PROFILE SECTION (NEW) -->
        <!-- ========================================================================= -->
        <div id="profileSection" class="p-4" style="display:block;">
            <h2 class="text-4xl font-extrabold text-white mb-6 border-b border-gray-700 pb-3">
                Профиль Telegram
            </h2>
            <div class="max-w-md mx-auto p-6 bg-gray-700 rounded-xl shadow-2xl">
                <div class="flex flex-col items-center mb-6">
                    <!-- Avatar Placeholder -->
                    <div class="w-24 h-24 bg-blue-500 rounded-full flex items-center justify-center mb-4 border-4 border-gray-500 overflow-hidden">
                        <!-- Using a placeholder image with 'TG' text -->
                        <img src="https://placehold.co/96x96/4a5568/ffffff?text=TG" alt="Аватар" class="w-full h-full object-cover opacity-90">
                    </div>
                    
                    <p id="profileNickname" class="text-3xl font-bold text-white">Крипто-Шахтер</p>
                    <p id="profileUsername" class="text-lg text-gray-400">@TON_Miner_777</p>
                </div>

                <div class="space-y-4 pt-4 border-t border-gray-600">
                    <div class="p-3 bg-gray-800 rounded-lg">
                        <p class="text-sm uppercase text-gray-400">Ваш ID (для системы/переводов)</p>
                        <p id="profileTelegramId" class="text-xl font-mono text-green-400 break-all mt-1">Загрузка...</p>
                    </div>
                    
                    <div class="p-3 bg-gray-800 rounded-lg">
                        <p class="text-sm uppercase text-gray-400">Текущий Хэшрейт Фермы</p>
                        <p id="profileHashrate" class="text-xl font-bold text-blue-400 mt-1">0 MH/s</p>
                    </div>

                    <div class="p-3 bg-gray-800 rounded-lg">
                        <p class="text-sm uppercase text-gray-400">Накоплено TON (Кошелек)</p>
                        <p id="profileTonWallet" class="text-xl font-bold text-purple-400 mt-1">0.0000 TON</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================================= -->
        <!-- 1. MINING DASHBOARD SECTION -->
        <!-- ========================================================================= -->
        <div id="miningDashboard" class="p-4" style="display:none;">
            <h2 class="text-4xl font-extrabold text-green-400 mb-6 border-b border-gray-700 pb-3">
                Ферма - Панель Управления
            </h2>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- Balance Card (USD) -->
                <div class="p-6 bg-gray-700 rounded-lg shadow-xl border-l-4 border-yellow-500">
                    <p class="text-gray-400 text-sm uppercase">Текущий Баланс (USD)</p>
                    <p id="currentBalance" class="text-4xl font-bold text-white mt-1">
                        100 $
                    </p>
                    <p class="text-xs text-gray-500 mt-2">Баланс, доступный для покупок.</p>
                </div>
                
                <!-- Hashrate Card -->
                <div class="p-6 bg-gray-700 rounded-lg shadow-xl border-l-4 border-blue-500">
                    <p class="text-gray-400 text-sm uppercase">Общая Мощность Фермы</p>
                    <p id="totalHashrate" class="text-4xl font-bold text-white mt-1">
                        0 MH/s
                    </p>
                    <p class="text-xs text-gray-500 mt-2">Мощность всех установленных видеокарт.</p>
                </div>

                <!-- TON Earned Card -->
                <div class="p-6 bg-gray-700 rounded-lg shadow-xl border-l-4 border-purple-500">
                    <p class="text-gray-400 text-sm uppercase">Накоплено TON (для сбора)</p>
                    <div class="flex items-center justify-between mt-1">
                        <p id="pendingTonEarnedDisplay" class="text-4xl font-bold text-white">
                            0.0000 TON
                        </p>
                        <button id="collectTonBtn" onclick="collectTon()" 
                                class="px-3 py-1 bg-purple-600 text-white text-sm font-semibold rounded-full shadow-md transition duration-200 hover:bg-purple-700 disabled:opacity-50 min-w-[100px]"
                                disabled>
                            Собрать
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">После сбора TON будут в вашем кошельке.</p>
                </div>
                
                <!-- TON Price Card -->
                <div class="p-6 bg-gray-700 rounded-lg shadow-xl border-l-4 border-red-500">
                    <p class="text-gray-400 text-sm uppercase">Цена TON</p>
                    <p id="tonPrice" class="text-4xl font-bold text-white mt-1">
                        15 $
                    </p>
                    <p class="text-xs text-gray-500 mt-2">Курс: 1 TON = 15 USD.</p>
                </div>
            </div>

            <div class="mt-8 p-6 bg-gray-800 rounded-lg">
                <h3 class="text-xl font-semibold text-gray-300 mb-4">Журнал Операций</h3>
                <ul id="operationsLog" class="space-y-2 text-sm text-gray-400">
                    <!-- Log entries will be added here -->
                    <li>[00:00:00] Игра запущена.</li>
                </ul>
            </div>
        </div>

        <!-- ========================================================================= -->
        <!-- 2. PRODUCT SHOP SECTION -->
        <!-- ========================================================================= -->
        <div id="productShop" class="p-4" style="display:none;">
            <h1 class="text-4xl font-extrabold text-gray-100 mb-4 text-center">
                Видеокарты для Вашей Фермы
            </h1>
            <p class="text-center text-gray-400 mb-10">
                Все карты в наличии в НЕОГРАНИЧЕННОМ количестве.
            </p>

            <!-- Product Grid Container -->
            <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Cards will be injected here by JavaScript -->
            </div>
        </div>
        <!-- End Product Shop Section -->

        <!-- ========================================================================= -->
        <!-- 3. BANK SECTION -->
        <!-- ========================================================================= -->
        <div id="bankSection" class="p-4" style="display:none;">
            <h2 class="text-4xl font-extrabold text-yellow-400 mb-6 border-b border-gray-700 pb-3">
                Банк "Крипто-Капитал"
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Deposit/Interest Card -->
                <div class="p-6 bg-gray-700 rounded-lg shadow-xl border-l-4 border-yellow-500 lg:col-span-2">
                    <h3 class="text-2xl font-semibold text-white mb-4">Депозит "Выгодный" (Почасовой)</h3>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg border border-yellow-700">
                            <span class="text-gray-300">Ваш Депозит:</span>
                            <span id="depositBalanceDisplay" class="text-3xl font-bold text-yellow-400">0 $</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg border border-green-700">
                            <span class="text-gray-300">Действующая Ставка (в час):</span>
                            <span id="effectiveInterestRateDisplay" class="text-3xl font-bold text-green-400">5.0%</span>
                        </div>
                        
                        <p class="text-sm text-gray-400 mt-2">
                            Внесение и снятие средств производится полностью. Ставка повышается покупкой улучшения.
                        </p>
                    </div>

                    <div class="mt-6 space-y-3">
                        <!-- Deposit/Withdraw All Buttons -->
                        <div class="flex space-x-4">
                            <button onclick="depositAll()" class="w-1/2 py-2 bg-yellow-600 text-gray-900 font-semibold rounded-lg hover:bg-yellow-500 transition">Внести Все</button>
                            <button onclick="withdrawAll()" class="w-1/2 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-500 transition">Снять Все</button>
                        </div>
                        
                        <h4 class="text-xl font-semibold text-gray-300 pt-4 border-t border-gray-600">Улучшение Ставки</h4>
                        <!-- Upgrade Buttons - Text updated by JS on load -->
                        <button id="upgradeStandardBtn" onclick="buyRateUpgrade(false)" class="w-full py-2 bg-green-700 text-white font-semibold rounded-lg hover:bg-green-600 transition">
                            Улучшить Ставку: +1%
                        </button>
                        <button id="upgradeSpecialBtn" onclick="buyRateUpgrade(true)" class="w-full py-2 bg-blue-700 text-white font-semibold rounded-lg hover:bg-blue-600 transition">
                            Специальное Улучшение: +100%
                        </button>
                    </div>
                </div>

                <!-- Send Money Card -->
                <div class="p-6 bg-gray-700 rounded-lg shadow-xl border-l-4 border-blue-500">
                    <h3 class="text-2xl font-semibold text-white mb-4">Перевод Другу (Мок)</h3>
                    <p class="text-sm text-gray-400 mb-4">Используйте Telegram ID или Username получателя (из его Профиля).</p>
                    <div class="space-y-4">
                         <label for="recipientIdInput" class="block text-sm font-medium text-gray-300">Telegram ID/Username Получателя:</label>
                         <input type="text" id="recipientIdInput" placeholder="Telegram ID, Username (@user) или 28-значный ID" class="input-base w-full">
                         
                         <label for="transferAmountInput" class="block text-sm font-medium text-gray-300">Сумма Перевода ($):</label>
                         <input type="number" id="transferAmountInput" placeholder="0" min="1" class="input-base w-full">
                         
                         <button onclick="sendMoneyToFriend()" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500 transition">Отправить Средства</button>
                    </div>
                </div>
            </div>

            <p class="mt-8 text-sm text-gray-500 italic">
                *Проценты начисляются в симуляции каждые 5 секунд. Перевод другу — это моковая функция, которая списывает деньги, но не гарантирует реального зачисления другому пользователю вне среды Canvas.
            </p>
        </div>

        <!-- ========================================================================= -->
        <!-- 4. MARKET SECTION (NEW) -->
        <!-- ========================================================================= -->
        <div id="marketSection" class="p-4" style="display:none;">
            <h2 class="text-4xl font-extrabold text-blue-400 mb-6 border-b border-gray-700 pb-3">
                Рынок TON - Обмен на USD
            </h2>

            <div class="p-6 bg-gray-700 rounded-lg shadow-xl border-l-4 border-blue-500 max-w-xl mx-auto">
                <h3 class="text-2xl font-semibold text-white mb-4">Продать Ваши TON</h3>

                <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg border border-purple-700 mb-4">
                    <span class="text-gray-300">TON в Кошельке (доступно для продажи):</span>
                    <span id="marketTonBalanceDisplay" class="text-3xl font-bold text-purple-400">0.0000 TON</span>
                </div>

                <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg border border-red-700 mb-6">
                    <span class="text-gray-300">Текущий Курс Обмена:</span>
                    <span id="marketTonPriceDisplay" class="text-3xl font-bold text-red-400">15.00 $</span>
                </div>

                <div class="mb-6">
                    <p class="text-lg font-medium text-gray-300">При продаже всего TON вы получите:</p>
                    <p id="estimatedUsdGain" class="text-4xl font-extrabold text-green-400 mt-2">0.00 $</p>
                </div>
                
                <button id="sellAllTonBtn" onclick="sellAllTon()" 
                        class="w-full py-3 bg-blue-600 text-white text-xl font-bold rounded-lg hover:bg-blue-500 transition disabled:opacity-50"
                        disabled>
                    Продать ВСЕ TON
                </button>

                <p class="mt-4 text-sm text-gray-400 italic">
                    Продажа происходит по фиксированному курсу. Средства будут немедленно зачислены на ваш USD баланс.
                </p>
            </div>
        </div>


        <!-- ========================================================================= -->
        <!-- 5. WALLET SECTION -->
        <!-- ========================================================================= -->
        <div id="walletSection" class="p-4" style="display:none;">
            <h2 class="text-4xl font-extrabold text-purple-400 mb-6 border-b border-gray-700 pb-3">
                Общий Кошелек Активов
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- USD Total -->
                <div class="p-6 bg-gray-700 rounded-lg shadow-xl border-l-4 border-yellow-500">
                    <p class="text-gray-400 text-sm uppercase">Доступный Баланс (USD)</p>
                    <p id="walletCurrentBalanceDisplay" class="text-5xl font-bold text-white mt-2">
                        <!-- Balance will be updated here -->
                    </p>
                    <p class="text-xs text-gray-500 mt-2">Средства для покупок и депозитов.</p>
                </div>

                <!-- TON Wallet Balance -->
                <div class="p-6 bg-gray-700 rounded-lg shadow-xl border-l-4 border-blue-500">
                    <p class="text-gray-400 text-sm uppercase">TON в Кошельке (для продажи)</p>
                    <p id="walletTonBalanceDisplay" class="text-5xl font-bold text-white mt-2">
                         <!-- TON available for sale will be updated here -->
                    </p>
                    <p class="text-xs text-gray-500 mt-2">Продайте их на вкладке "Рынок TON".</p>
                </div>
                
            </div>
            
        </div>


        <!-- Confirmation Message Box (Single, for all actions) -->
        <div id="messageBox" class="fixed bottom-4 right-4 p-4 text-sm rounded-lg transition duration-300 opacity-0 hidden z-50 shadow-2xl" role="alert">
            <!-- Message content will be inserted here -->
        </div>
    </div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug'); // Uncomment to see Firebase logs in console
        
        // --- GAME CONSTANTS ---
        const currencyUnit = 'долларов ($)';
        const miningCrypto = 'TON';
        const cryptoPriceUsd = 15; // 1 TON = 15 USD

        // Mining simulation parameters
        const baseTonPerMHS = 0.0001; // TON earned per MH/s per second
        const miningIntervalMs = 1000; // Update cycle every 1 second (1000ms)
        
        // Bank simulation parameters
        const bankIntervalMs = 5000; // 5 seconds simulates 1 hour
        const rateUpgradeCost = 1000; // $1,000 for +1%
        const specialRateUpgradeCost = 130000; // $130,000 for +100%

        // --- GLOBAL GAME STATE (Initial Values) ---
        let gameState = {
            balance: 100, // Starting balance 100 $ (Available funds)
            totalHashrate: 0,
            installedCardsCount: 0,
            pendingTonEarned: 0, 
            tonWalletBalance: 0, // TON collected and ready for sale
            purchases: {},
            depositBalance: 0, // Deposited money in the bank
            purchasedInterestRate: 5, 
        };

        // --- MOCK PROFILE DATA ---
        const mockProfile = {
            nickname: 'Крипто-Шахтер',
            username: '@TON_Miner_777', // Моковое имя пользователя. Если нет, поставить null.
            // Аватарка обрабатывается через CSS/HTML
        };
        
        // --- FIREBASE GLOBALS ---
        let db, auth;
        let userId = null;
        let isAuthReady = false;

        // --- INTERVAL GLOBALS ---
        let bankInterval;
        let miningInterval;


        // --- FIREBASE CONFIG & PATHS (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestore Paths (Private User Data)
        const getGameStateRef = (uid) => {
            return doc(db, 'artifacts', appId, 'users', uid, 'game_state', 'current');
        };

        // Function to handle exponential backoff for API calls (MANDATORY)
        async function fetchWithRetry(apiCall, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    console.error(`Firebase operation failed. Retrying in ${delay / 1000}s...`, error.message);
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
            // Should not be reached if retries > 0, but added for completeness
            throw new Error("Failed to execute Firebase operation after multiple retries.");
        }
        
        /**
         * Centralized function to show transient success/error messages.
         */
        function showMessage(title, message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            
            let classes = "fixed bottom-4 right-4 p-4 text-sm rounded-lg transition duration-300 opacity-100 z-50 shadow-2xl border ";
            let bgColor, textColor, borderColor;

            if (type === 'success') {
                bgColor = 'bg-green-900';
                textColor = 'text-green-300';
                borderColor = 'border-green-700';
            } else if (type === 'error') {
                bgColor = 'bg-red-900';
                textColor = 'text-red-300';
                borderColor = 'border-red-700';
            } else if (type === 'info') {
                bgColor = 'bg-purple-900';
                textColor = 'text-purple-300';
                borderColor = 'border-purple-700';
            }
            
            messageBox.className = `${classes} ${bgColor} ${textColor} ${borderColor}`;
            messageBox.innerHTML = `<strong>${title}:</strong> ${message}`;
            messageBox.style.display = 'block';

            // Hide message after 5 seconds
            setTimeout(() => {
                messageBox.style.opacity = 0;
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 300);
            }, 5000);
        }

        /**
         * Formats a number for display.
         */
        function formatNumber(num, fixed = 2) {
            const parsedNum = parseFloat(num);
            if (isNaN(parsedNum)) return '0';
            const multiplier = Math.pow(10, fixed);
            const roundedNum = Math.round(parsedNum * multiplier) / multiplier;
            
            // Format to use spaces as thousands separators (Russian locale)
            return new Intl.NumberFormat('ru-RU', {
                minimumFractionDigits: fixed,
                maximumFractionDigits: fixed
            }).format(roundedNum);
        }

        /**
         * Calculates the effective interest rate (now just returns the purchased rate).
         */
        function calculateInterestRate() {
            // The rate is now determined only by purchases, not the deposit amount.
            return gameState.purchasedInterestRate; 
        }

        /**
         * Applies the calculated hourly interest to the deposit balance.
         */
        function applyBankInterest() {
            if (gameState.depositBalance > 0 && isAuthReady) {
                // 1. Calculate the rate
                const hourlyRate = calculateInterestRate();
                
                // 2. Determine the time factor (5 seconds / 3600 seconds per hour)
                const timeFactor = bankIntervalMs / (1000 * 3600); 

                // 3. Calculate actual interest earned in this interval
                const interestEarned = gameState.depositBalance * (hourlyRate / 100) * timeFactor;

                // 4. Update the deposit balance
                gameState.depositBalance += interestEarned;
                
                // 5. Update UI
                updateDashboard();
                
                // 6. Log every 12 intervals (60 seconds)
                if (Math.floor(Date.now() / bankIntervalMs) % 12 === 0) {
                     logOperation(`БАНК: Доход ${interestEarned.toFixed(4)} $ (${hourlyRate.toFixed(1)}% в час).`);
                }
            }
        }

        /**
         * Adds an entry to the operations log on the dashboard.
         */
        function logOperation(message) {
            const logElement = document.getElementById('operationsLog');
            if (!logElement) return;

            const now = new Date();
            const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const newEntry = document.createElement('li');
            newEntry.textContent = `[${timeString}] ${message}`;

            // Add to the top of the list
            logElement.prepend(newEntry);
            
            // Keep the log short (e.g., max 10 entries)
            while (logElement.children.length > 10) {
                logElement.removeChild(logElement.lastChild);
            }
        }

        /**
         * Updates the display of the Mining Dashboard and all other sections.
         */
        function updateDashboard() {
            if (!isAuthReady) return; 
            
            const formattedBalance = formatNumber(gameState.balance);
            const formattedDeposit = formatNumber(gameState.depositBalance);
            const effectiveRate = calculateInterestRate(); 

            // 1. Dashboard updates (Mining)
            document.getElementById('currentBalance').textContent = formattedBalance + ' $';
            document.getElementById('totalHashrate').textContent = formatNumber(gameState.totalHashrate, 0) + ' MH/s';
            document.getElementById('tonPrice').textContent = cryptoPriceUsd + ' $';

            // 2. TON Earnings
            const pendingTon = gameState.pendingTonEarned;
            document.getElementById('pendingTonEarnedDisplay').textContent = pendingTon.toFixed(4) + ` ${miningCrypto}`;
            
            // Toggle Collect Button state
            const collectBtn = document.getElementById('collectTonBtn');
            if (collectBtn) {
                collectBtn.disabled = pendingTon < 0.0001; 
                collectBtn.textContent = pendingTon > 0 ? `Собрать (${pendingTon.toFixed(4)} TON)` : `Собрать`;
            }
            
            // 3. Bank updates
            const depositDisplay = document.getElementById('depositBalanceDisplay');
            const rateDisplay = document.getElementById('effectiveInterestRateDisplay');
            if (depositDisplay) depositDisplay.textContent = formattedDeposit + ' $';
            if (rateDisplay) rateDisplay.textContent = `${effectiveRate.toFixed(1)}%`;

            // 4. Market updates
            const currentTonBalance = gameState.tonWalletBalance;
            const estimatedGain = currentTonBalance * cryptoPriceUsd;

            const marketTonBalanceDisplay = document.getElementById('marketTonBalanceDisplay');
            if (marketTonBalanceDisplay) marketTonBalanceDisplay.textContent = currentTonBalance.toFixed(4) + ` ${miningCrypto}`;

            const marketTonPriceDisplay = document.getElementById('marketTonPriceDisplay');
            if (marketTonPriceDisplay) marketTonPriceDisplay.textContent = cryptoPriceUsd.toFixed(2) + ' $';
            
            const estimatedUsdGain = document.getElementById('estimatedUsdGain');
            if (estimatedUsdGain) estimatedUsdGain.textContent = formatNumber(estimatedGain, 2) + ' $';
            
            const sellAllTonBtn = document.getElementById('sellAllTonBtn');
            if (sellAllTonBtn) sellAllTonBtn.disabled = currentTonBalance < 0.0001;


            // 5. Wallet updates
            const walletCurrentBalanceDisplay = document.getElementById('walletCurrentBalanceDisplay');
            const walletTonBalanceDisplay = document.getElementById('walletTonBalanceDisplay');
            
            if (walletCurrentBalanceDisplay) walletCurrentBalanceDisplay.textContent = formattedBalance + ' $';
            if (walletTonBalanceDisplay) walletTonBalanceDisplay.textContent = gameState.tonWalletBalance.toFixed(4) + ` ${miningCrypto}`;

            // 6. User ID Display (Header)
            const userIdDisplay = document.getElementById('currentUserId');
            if (userIdDisplay && userId) {
                 userIdDisplay.textContent = userId;
            }

            // 7. Profile updates
            const profileTelegramId = document.getElementById('profileTelegramId');
            const profileHashrate = document.getElementById('profileHashrate');
            const profileTonWallet = document.getElementById('profileTonWallet');
            const profileUsername = document.getElementById('profileUsername');

            if (profileTelegramId && userId) profileTelegramId.textContent = userId;
            if (profileHashrate) profileHashrate.textContent = formatNumber(gameState.totalHashrate, 0) + ' MH/s';
            if (profileTonWallet) profileTonWallet.textContent = gameState.tonWalletBalance.toFixed(4) + ` ${miningCrypto}`;
            
            if (profileUsername) {
                // Check if username is 'set' in mock data
                if (mockProfile.username) {
                    profileUsername.textContent = mockProfile.username;
                    profileUsername.classList.remove('text-red-400');
                    profileUsername.classList.add('text-gray-400');
                } else {
                    profileUsername.textContent = 'не задано';
                    profileUsername.classList.remove('text-gray-400');
                    profileUsername.classList.add('text-red-400');
                }
            }
            const profileNickname = document.getElementById('profileNickname');
            if (profileNickname) profileNickname.textContent = mockProfile.nickname;
        }

        /**
         * Deposits all available cash into the bank.
         */
        window.depositAll = function() {
            if (!isAuthReady) return;
            if (gameState.balance <= 0) {
                showMessage('ОШИБКА ДЕПОЗИТА', 'Нечего вносить. Ваш баланс равен 0 $.', 'error');
                return;
            }
            
            const amount = gameState.balance;
            gameState.balance = 0;
            gameState.depositBalance += amount;
            
            logOperation(`ДЕПОЗИТ: Внесено ВСЕ (${formatNumber(amount)} $) под ${calculateInterestRate().toFixed(1)}% в час.`);
            showMessage('УСПЕХ', `Внесено ${formatNumber(amount)} $ на депозит.`, 'success');

            updateDashboard();
            saveGameState();
        }

        /**
         * Withdraws all deposited money into the cash balance.
         */
        window.withdrawAll = function() {
            if (!isAuthReady) return;
            if (gameState.depositBalance <= 0) {
                showMessage('ОШИБКА ВЫВОДА', 'На депозите нет средств для снятия.', 'error');
                return;
            }
            
            const amount = gameState.depositBalance;
            gameState.depositBalance = 0;
            gameState.balance += amount;
            
            logOperation(`ВЫВОД: Снято ВСЕ (${formatNumber(amount)} $) с депозита.`);
            showMessage('УСПЕХ', `Выведено ${formatNumber(amount)} $ с депозита.`, 'success');

            updateDashboard();
            saveGameState();
        }

        /**
         * Handles the purchase of interest rate upgrades.
         */
        window.buyRateUpgrade = function(isSpecial) {
            if (!isAuthReady) return;
            let cost, rateIncrease, upgradeName;

            if (isSpecial) {
                cost = specialRateUpgradeCost;
                rateIncrease = 100;
                upgradeName = 'Специальный (+100%)';
            } else {
                cost = rateUpgradeCost;
                rateIncrease = 1;
                upgradeName = 'Стандартный (+1%)';
            }

            if (gameState.balance < cost) {
                showMessage('ОШИБКА ПОКУПКИ', `Недостаточно средств. Нужно ${formatNumber(cost)} $. Ваш баланс: ${formatNumber(gameState.balance)} $.`, 'error');
                return;
            }

            gameState.balance -= cost;
            gameState.purchasedInterestRate += rateIncrease;

            logOperation(`УЛУЧШЕНИЕ: Куплен апгрейд "${upgradeName}" за ${formatNumber(cost)} $. Новая ставка: ${gameState.purchasedInterestRate.toFixed(1)}%`);
            showMessage('УСПЕХ', `Ставка улучшена на +${rateIncrease}%. Текущая ставка: ${gameState.purchasedInterestRate.toFixed(1)}%`, 'success');
            
            updateDashboard();
            saveGameState();
        }

        /**
         * Handles the mock transfer of funds to another user ID.
         */
        window.sendMoneyToFriend = function() {
            if (!isAuthReady) return;
            const recipientIdInput = document.getElementById('recipientIdInput');
            const transferAmountInput = document.getElementById('transferAmountInput');
            
            const recipientId = recipientIdInput.value.trim();
            let amount = parseFloat(transferAmountInput.value);
            
            if (!recipientId || recipientId.length < 3) { // Minimal check for username or ID
                showMessage('ОШИБКА ПЕРЕВОДА', 'Введите корректный Telegram ID или Username получателя.', 'error');
                return;
            }
            
            // Check if user is trying to send to self (using their numeric ID or mock username)
            if (recipientId === userId || recipientId === mockProfile.username) {
                showMessage('ОШИБКА ПЕРЕВОДА', 'Вы не можете отправить деньги самому себе.', 'error');
                return;
            }

            if (isNaN(amount) || amount <= 0) {
                showMessage('ОШИБКА ПЕРЕВОДА', 'Введите корректную сумму для перевода.', 'error');
                return;
            }
            
            amount = parseFloat(amount.toFixed(2));
            
            if (amount > gameState.balance) {
                showMessage('ОШИБКА ПЕРЕВОДА', `Недостаточно средств. Ваш баланс: ${formatNumber(gameState.balance)} $`, 'error');
                return;
            }

            // --- Mock Transfer Execution ---
            gameState.balance -= amount;
            
            // Clear inputs
            recipientIdInput.value = '';
            transferAmountInput.value = '';
            
            // Determine recipient display name for log
            const recipientDisplay = recipientId.startsWith('@') ? recipientId : recipientId.substring(0, 8) + '...';

            // Log and UI update
            logOperation(`ПЕРЕВОД: Отправлено ${formatNumber(amount)} $ пользователю ${recipientDisplay}`);
            updateDashboard();
            saveGameState();
            showMessage('ПЕРЕВОД УСПЕШЕН', `Имитация отправки ${formatNumber(amount)} $ пользователю ${recipientDisplay}`, 'info');
        }

        /**
         * Starts the continuous mining simulation loop and bank interest.
         */
        function startSimulation() {
            logOperation(`Начат майнинг ${miningCrypto} по курсу ${cryptoPriceUsd} $.`);
            logOperation(`Начат расчет банковских процентов (обновление каждые ${bankIntervalMs / 1000} сек).`);

            // Start Mining Loop
            miningInterval = setInterval(() => {
                if (gameState.totalHashrate > 0) {
                    const tonEarned = gameState.totalHashrate * baseTonPerMHS * (miningIntervalMs / 1000);
                    gameState.pendingTonEarned += tonEarned; 

                    // Log mining every 10 seconds (10 intervals)
                    if (Math.floor(Date.now() / 1000) % 10 === 0) {
                        logOperation(`Накоплено ~${(tonEarned * 10).toFixed(6)} TON за 10 сек.`);
                    }
                    updateDashboard();
                }
            }, miningIntervalMs);
            
            // Start Bank Interest Loop
            bankInterval = setInterval(() => {
                applyBankInterest();
                // Save every time interest is applied to ensure deposit growth is saved
                saveGameState(); 
            }, bankIntervalMs); 
        }

        /**
         * Collects pending TON earnings and moves them to the TON Wallet balance.
         */
        window.collectTon = function() {
            if (!isAuthReady) return;
            if (gameState.pendingTonEarned < 0.0001) {
                showMessage('ПРЕДУПРЕЖДЕНИЕ', 'Нечего собирать.', 'info');
                return; 
            }
            
            const tonToCollect = gameState.pendingTonEarned;

            gameState.tonWalletBalance += tonToCollect; // Add to TON wallet
            gameState.pendingTonEarned = 0; 

            logOperation(`СОБРАНО: ${tonToCollect.toFixed(4)} TON. Переведены в Кошелек TON.`);
            updateDashboard();

            saveGameState();
            showMessage('СБОР УСПЕШЕН', `Успешно собрано ${tonToCollect.toFixed(4)} TON! Теперь они в Кошельке.`, 'info');
        }

        /**
         * Sells all TON in the wallet for USD at the current fixed rate.
         */
        window.sellAllTon = function() {
            if (!isAuthReady) return;
            if (gameState.tonWalletBalance < 0.0001) {
                showMessage('ОШИБКА ПРОДАЖИ', 'В вашем кошельке нет TON для продажи.', 'error');
                return;
            }

            const tonToSell = gameState.tonWalletBalance;
            const usdGain = tonToSell * cryptoPriceUsd;

            gameState.balance += usdGain;
            gameState.tonWalletBalance = 0;

            logOperation(`ПРОДАЖА: Продано ${tonToSell.toFixed(4)} TON по курсу ${cryptoPriceUsd} $. Получено ${formatNumber(usdGain, 2)} $`);
            updateDashboard();
            saveGameState();
            showMessage('ОБМЕН УСПЕШЕН', `Вы продали ${tonToSell.toFixed(4)} TON и получили ${formatNumber(usdGain, 2)} $!`, 'success');
        }


        /**
         * Loads game state from Firestore and starts the periodic save.
         */
        async function loadGameState() {
            if (!db || !userId) {
                isAuthReady = true;
                logOperation("Внимание: Firebase не инициализирован. Используется локальный/начальный баланс.");
                updateDashboard();
                return;
            }
            
            try {
                const docRef = getGameStateRef(userId);
                const docSnap = await fetchWithRetry(() => getDoc(docRef));

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Load and merge data from Firestore, ensuring all keys are present
                    gameState = {
                        balance: data.balance || 100,
                        totalHashrate: data.totalHashrate || 0,
                        installedCardsCount: data.installedCardsCount || 0,
                        pendingTonEarned: data.pendingTonEarned || 0,
                        tonWalletBalance: data.tonWalletBalance || 0, 
                        purchases: data.purchases || {},
                        depositBalance: data.depositBalance || 0, 
                        purchasedInterestRate: data.purchasedInterestRate || 5, 
                    };
                    logOperation(`Состояние игры загружено из базы данных. Баланс: ${formatNumber(gameState.balance)} $`);
                } else {
                    await saveGameState(); 
                    logOperation("Состояние игры инициализировано (новый игрок).");
                }
            } catch (e) {
                console.error("Ошибка загрузки состояния игры:", e);
                logOperation(`ОШИБКА: Не удалось загрузить состояние игры (${e.message}). Использован локальный баланс.`);
            }

            isAuthReady = true;
            updateDashboard();
        }

        /**
         * Saves current game state to Firestore.
         */
        async function saveGameState() {
            if (!db || !userId || !isAuthReady) return;

            try {
                const docRef = getGameStateRef(userId);
                
                const dataToSave = {
                    balance: gameState.balance,
                    totalHashrate: gameState.totalHashrate,
                    installedCardsCount: gameState.installedCardsCount,
                    pendingTonEarned: gameState.pendingTonEarned,
                    tonWalletBalance: gameState.tonWalletBalance, 
                    purchases: gameState.purchases,
                    depositBalance: gameState.depositBalance, 
                    purchasedInterestRate: gameState.purchasedInterestRate, 
                };
                
                await fetchWithRetry(() => setDoc(docRef, dataToSave));
                // console.log("Game state saved successfully.");
            } catch (e) {
                console.error("Ошибка сохранения состояния игры:", e);
            }
        }

        /**
         * Switches the visibility between the main sections.
         */
        window.showSection = function(sectionName) { 
            const sections = {
                'profile': document.getElementById('profileSection'),
                'mining': document.getElementById('miningDashboard'),
                'shop': document.getElementById('productShop'),
                'bank': document.getElementById('bankSection'),
                'market': document.getElementById('marketSection'), 
                'wallet': document.getElementById('walletSection')
            };

            const navs = {
                'profile': document.getElementById('navProfile'),
                'mining': document.getElementById('navMining'),
                'shop': document.getElementById('navShop'),
                'bank': document.getElementById('navBank'),
                'market': document.getElementById('navMarket'), 
                'wallet': document.getElementById('navWallet')
            };

            for (const key in sections) {
                if (sections[key]) { 
                    sections[key].style.display = 'none';
                }
                if (navs[key]) { 
                    navs[key].classList.remove('tab-active');
                }
            }

            if (sections[sectionName]) {
                sections[sectionName].style.display = 'block';
                if (navs[sectionName]) {
                    navs[sectionName].classList.add('tab-active');
                }
            }

            updateDashboard();
        }

        // --- PRODUCT LOGIC (Mostly Unchanged) ---
        const products = [
            // Sorted by price in renderProducts()
            { id: 10, name: 'RTX 5090 HASH', price: 85000, hashrate: 300, imageText: 'GPU 5090' },
            { id: 11, name: 'RTX 4080 MAX', price: 60000, hashrate: 200, imageText: 'GPU 4080' },
            { id: 12, name: 'RTX 4070 TURBO', price: 45000, hashrate: 150, imageText: 'GPU 4070' },
            { id: 13, name: 'RTX 3090 TITAN', price: 70000, hashrate: 250, imageText: 'GPU 3090' },
            { id: 14, name: 'RTX 3070 PRO', price: 35000, hashrate: 120, imageText: 'GPU 3070' },
            { id: 15, name: 'RTX 3060 ECO', price: 28000, hashrate: 80, imageText: 'GPU 3060' },
            { id: 16, name: 'Radeon RX 7900 X', price: 75000, hashrate: 280, imageText: 'AMD 7900' },
            { id: 17, name: 'Radeon RX 6800 XT', price: 50000, hashrate: 180, imageText: 'AMD 6800' },
            { id: 18, name: 'GTX 1080 Ti LEGEND', price: 25000, hashrate: 65, imageText: 'GTX 1080' },
            { id: 19, name: 'GTX 1660 SUPER', price: 18000, hashrate: 40, imageText: 'GTX 1660' },
            { id: 20, name: 'Radeon RX 580', price: 15000, hashrate: 30, imageText: 'AMD 580' },
            { id: 21, name: 'Vega 64 LIQUID', price: 22000, hashrate: 55, imageText: 'AMD Vega' },
            { id: 22, name: 'RTX 2060 SUPER', price: 30000, hashrate: 100, imageText: 'RTX 2060' },
            { id: 23, name: 'GTX 1070', price: 19000, hashrate: 50, imageText: 'GTX 1070' },
            { id: 24, name: 'Radeon R9 390', price: 12000, hashrate: 25, imageText: 'AMD R9' },
            { id: 25, name: 'RTX A4000', price: 40000, hashrate: 130, imageText: 'RTX A4000' },
            { id: 26, name: 'GTX 970 GAMING', price: 10000, hashrate: 20, imageText: 'GTX 970' },
            { id: 27, name: 'RX 570 BASIC', price: 9000, hashrate: 18, imageText: 'RX 570' },
            { id: 28, name: 'GTX 750 Ti MINI', price: 5000, hashrate: 10, imageText: 'GTX 750' },
            { id: 29, name: 'GTX 660 HASH', price: 10, hashrate: 8, imageText: 'GTX 660' }, 
            { id: 30, name: 'Intel Arc A770', price: 32000, hashrate: 110, imageText: 'INTEL A770' },
            { id: 31, name: 'RTX 5050 MOBILE', price: 15000, hashrate: 50, imageText: 'RTX 5050' },
            { id: 32, name: 'Radeon VII', price: 48000, hashrate: 160, imageText: 'AMD VII' },
            { id: 33, name: 'Radeon RX 5700', price: 27000, hashrate: 90, imageText: 'RX 5700' },
            { id: 34, name: 'ASIC Miner Pro V3', price: 150000, hashrate: 600, imageText: 'ASIC V3' },
            { id: 35, name: 'Quantum Core GPU', price: 99999, hashrate: 450, imageText: 'Quantum' },
            { id: 36, name: 'GTX 1060 6GB', price: 17000, hashrate: 35, imageText: 'GTX 1060' },
            { id: 37, name: 'RTX 3080 VENTUS', price: 55000, hashrate: 190, imageText: 'RTX 3080' },
            { id: 38, name: 'Radeon RX 6600', price: 24000, hashrate: 75, imageText: 'RX 6600' },
            { id: 39, name: 'Tesla K80 SERVER', price: 38000, hashrate: 140, imageText: 'Tesla K80' }
        ];

        window.validateQuantity = function(inputElement, productId) {
            let value = parseInt(inputElement.value);
            if (isNaN(value) || value < 1) {
                inputElement.value = 1;
            } else {
                if (value > 999999) {
                     inputElement.value = 999999;
                } else {
                    inputElement.value = value;
                }
            }
            updateTotal(productId);
        }

        window.changeQuantity = function(step, productId) {
            const quantityInput = document.getElementById(`quantityInput-${productId}`);
            let currentQuantity = parseInt(quantityInput.value);
            let newQuantity = currentQuantity + step;
            
            if (newQuantity < 1) {
                newQuantity = 1; 
            }
            if (newQuantity > 999999) {
                newQuantity = 999999; 
            }

            quantityInput.value = newQuantity;
            updateTotal(productId);
        }

        function updateTotal(productId) {
            const product = products.find(p => p.id === productId);
            const quantityInput = document.getElementById(`quantityInput-${productId}`);
            const totalPriceElement = document.getElementById(`totalPrice-${productId}`);
            
            if (!product || !quantityInput || !totalPriceElement) return;

            const quantity = parseInt(quantityInput.value) || 1;
            const total = quantity * product.price;
            
            totalPriceElement.textContent = formatNumber(total, 2) + ' ' + currencyUnit;
        }

        window.addToCart = function(productId) {
            if (!isAuthReady) {
                 showMessage('ОШИБКА', 'Подождите, пока загрузится база данных.', 'error');
                 return;
            }
            const product = products.find(p => p.id === productId);
            const quantityInput = document.getElementById(`quantityInput-${productId}`);
            
            if (!product || !quantityInput) {
                 showMessage('ОШИБКА', 'Продукт не найден.', 'error');
                 return;
            }

            const quantity = parseInt(quantityInput.value) || 1;
            const itemCost = quantity * product.price;

            if (itemCost > gameState.balance) {
                showMessage('ОШИБКА ПОКУПКИ', `Недостаточно средств. Вам не хватает ${formatNumber(itemCost - gameState.balance)} $`, 'error');
                return;
            }

            gameState.balance -= itemCost;
            gameState.totalHashrate += quantity * product.hashrate;
            gameState.installedCardsCount += quantity;
            
            gameState.purchases[productId] = (gameState.purchases[productId] || 0) + quantity;

            logOperation(`КУПЛЕНО: ${formatNumber(quantity)} x "${product.name}" за ${formatNumber(itemCost)} $. Хэшрейт: +${product.hashrate * quantity} MH/s.`);

            quantityInput.value = 1;
            updateTotal(productId);
            updateDashboard(); 
            
            saveGameState(); 

            const message = `Вы купили ${formatNumber(quantity)} видеокарт "${product.name}"! Всего потрачено: ${formatNumber(itemCost)} ${currencyUnit}.`;
            showMessage('ПОКУПКА УСПЕШНА', message, 'success');
        }

        function renderProducts() {
            products.sort((a, b) => a.price - b.price);

            const grid = document.getElementById('productGrid');
            grid.innerHTML = products.map(product => `
                <div class="gpu-card p-4 rounded-lg shadow-lg border border-gray-700 flex flex-col justify-between">
                    <div>
                        <div class="aspect-video overflow-hidden rounded-md mb-3 bg-gray-900 flex justify-center items-center">
                            <!-- Placeholder image for the GPU item -->
                            <img src="https://placehold.co/600x300/3182ce/ffffff?text=${product.imageText}" 
                                 alt="${product.name}" 
                                 class="w-full h-full object-cover opacity-90">
                        </div>
                        
                        <h3 class="text-xl font-bold text-gray-50 mb-1">ID ${product.id}: ${product.name}</h3>
                        
                        <div class="text-sm text-gray-400 mb-4 space-y-1">
                            <p>Хэшрейт: <span class="font-semibold text-green-400">${product.hashrate} MH/s</span></p>
                            <p>На Складе: <span class="text-blue-400 font-extrabold">НЕОГРАНИЧЕНО</span></p>
                        </div>
                    </div>

                    <div class="space-y-4 pt-3 border-t border-gray-700">
                        <!-- Price -->
                        <div class="flex justify-between items-baseline">
                            <span class="text-base text-gray-400">Цена за шт:</span>
                            <span class="text-2xl font-bold text-green-400">${formatNumber(product.price, 0)} ${currencyUnit}</span>
                        </div>

                        <!-- Quantity Control -->
                        <div class="flex items-center space-x-3">
                            <label class="text-sm font-medium text-gray-300 flex-shrink-0">Кол-во:</label>
                            <div class="flex items-stretch border border-gray-600 rounded-lg overflow-hidden flex-grow">
                                <button onclick="changeQuantity(-1, ${product.id})" class="p-2 bg-gray-700 hover:bg-gray-600 transition text-gray-300 font-bold text-base w-8">-</button>
                                <input type="number" id="quantityInput-${product.id}" value="1" min="1" oninput="validateQuantity(this, ${product.id})" 
                                       class="quantity-input w-full text-center text-base font-semibold border-none focus:ring-0 p-1 bg-gray-800 text-white">
                                <button onclick="changeQuantity(1, ${product.id})" class="p-2 bg-gray-700 hover:bg-gray-600 transition text-gray-300 font-bold text-base w-8">+</button>
                            </div>
                        </div>

                        <!-- Total Price -->
                        <div class="flex justify-between items-baseline">
                            <span class="text-base text-gray-400">ИТОГО:</span>
                            <p class="text-2xl font-extrabold text-red-500" id="totalPrice-${product.id}">${formatNumber(product.price, 2)} ${currencyUnit}</p>
                        </div>

                        <!-- Buy Button -->
                        <button onclick="addToCart(${product.id})" 
                                class="w-full py-2 button-primary text-black font-semibold rounded-lg shadow-md transition duration-200 hover:scale-[1.01] active:scale-[0.99]">
                            КУПИТЬ И УСТАНОВИТЬ
                        </button>
                    </div>
                </div>
            `).join('');

            products.forEach(p => updateTotal(p.id));
        }
        
        /**
         * Updates the text of the upgrade buttons with current costs.
         */
        function updateBankUpgradeButtons() {
            const standardBtn = document.getElementById('upgradeStandardBtn');
            const specialBtn = document.getElementById('upgradeSpecialBtn');

            if (standardBtn) {
                standardBtn.textContent = `Улучшить Ставку: +1% за ${formatNumber(rateUpgradeCost, 0)} $`;
            }
            if (specialBtn) {
                specialBtn.textContent = `Специальное Улучшение: +100% за ${formatNumber(specialRateUpgradeCost, 0)} $`;
            }
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Check for initial auth token and sign in securely
                if (initialAuthToken) {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in if token is missing
                    await setPersistence(auth, browserLocalPersistence);
                    await signInAnonymously(auth);
                }

                // Wait for auth state to resolve
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            logOperation(`Пользователь авторизован (ID: ${userId.substring(0, 8)}...).`);
                            unsubscribe();
                            resolve();
                        } else {
                            logOperation("Ошибка авторизации. Запуск в гостевом режиме.");
                            unsubscribe();
                            resolve();
                        }
                    });
                });
                
                await loadGameState();
                startSimulation();

            } catch (error) {
                console.error("Ошибка инициализации или аутентификации Firebase:", error);
                logOperation(`КРИТИЧЕСКАЯ ОШИБКА: Не удалось подключиться к базе данных. Прогресс НЕ будет сохранен.`);
                isAuthReady = true; 
                updateDashboard();
                startSimulation();
            }
        }


        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            renderProducts();
            updateBankUpgradeButtons(); // Set button text on load
            showSection('profile'); // Show profile by default 
            await initFirebase(); 
        });
    </script>
</body>
</html>
