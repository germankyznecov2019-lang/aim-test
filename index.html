<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Red Vision Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background: #000;
            height: 100vh;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- ЗАГРУЗКА --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .loading-text {
            color: #ff0000; font-size: 24px; font-weight: 900; letter-spacing: 2px;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse { from { text-shadow: 0 0 10px #500; opacity: 0.5; } to { text-shadow: 0 0 25px #f00; opacity: 1; } }

        /* --- КАМЕРА --- */
        .viewport { position: relative; width: 100%; height: 100%; }
        video { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        video.mirrored { transform: scaleX(-1); } /* Для селфи */
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* --- UI ИНТЕРФЕЙС --- */
        .ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding-bottom: 40px;
            display: flex; flex-direction: column; align-items: center;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            z-index: 10;
        }

        /* Слайдер Зума */
        .zoom-container {
            width: 80%; display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 25px; color: #ff0000; font-weight: bold; font-size: 14px;
            opacity: 0; transition: opacity 0.3s; pointer-events: none; /* Скрыт по умолчанию */
        }
        .zoom-container.visible { opacity: 1; pointer-events: auto; }

        input[type=range] {
            -webkit-appearance: none; width: 70%; height: 2px; background: rgba(255, 0, 0, 0.3);
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; background: #000;
            border: 2px solid #ff0000; border-radius: 50%; box-shadow: 0 0 10px #ff0000;
        }

        /* Кнопки */
        .controls { display: flex; gap: 40px; }

        .btn {
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(20, 0, 0, 0.6);
            border: 1px solid rgba(255, 0, 0, 0.5);
            color: #ff0000;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.1);
            transition: all 0.2s; cursor: pointer;
        }
        .btn svg { width: 28px; height: 28px; fill: currentColor; }
        
        .btn:active { transform: scale(0.95); background: rgba(255, 0, 0, 0.2); }
        .btn.active { background: rgba(255, 0, 0, 0.3); box-shadow: 0 0 25px rgba(255, 0, 0, 0.6); border-color: #ff0000; }
        .btn:disabled { opacity: 0.3; border-color: #555; color: #555; box-shadow: none; pointer-events: none; }

    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-text" id="status-text">ЗАГРУЗКА СИСТЕМЫ...</div>
    </div>

    <div class="viewport">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        
        <div class="ui-layer">
            <div class="zoom-container" id="zoom-ui">
                <span>1x</span>
                <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1">
                <span id="zoom-max-text">5x</span>
            </div>

            <div class="controls">
                <button class="btn" id="btn-torch">
                    <svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>
                </button>
                
                <button class="btn" id="btn-flip">
                    <svg viewBox="0 0 24 24"><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5V13H9v2.5L5.5 12 9 8.5V11h6V8.5l3.5 3.5-3.5 3.5z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusText = document.getElementById('status-text');
        const loadingScreen = document.getElementById('loading-screen');
        
        const btnTorch = document.getElementById('btn-torch');
        const btnFlip = document.getElementById('btn-flip');
        const zoomUi = document.getElementById('zoom-ui');
        const zoomSlider = document.getElementById('zoom-slider');
        const zoomMaxText = document.getElementById('zoom-max-text');

        // Настройки
        let currentFacingMode = 'environment'; // Начинаем с задней камеры
        let stream = null;
        let track = null;
        let isTorchOn = false;
        let isModelLoaded = false;
        
        // Модель
        const DETECTOR_OPTIONS = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.2 });
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        // 1. Старт
        async function init() {
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL)
                ]);
                isModelLoaded = true;
                statusText.innerText = "ИНИЦИАЛИЗАЦИЯ КАМЕРЫ...";
                startCamera();
            } catch (err) {
                statusText.innerText = "ОШИБКА СИСТЕМЫ";
                statusText.style.color = "red";
            }
        }

        // 2. Логика камеры (со всеми проверками)
        async function startCamera() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 60 } // Пытаемся выжать FPS
                    }
                });
                video.srcObject = stream;
                
                // Получаем трек для управления зумом и вспышкой
                track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();

                // --- НАСТРОЙКА ЗУМА ---
                if ('zoom' in capabilities) {
                    zoomUi.classList.add('visible');
                    zoomSlider.min = capabilities.zoom.min;
                    zoomSlider.max = capabilities.zoom.max;
                    zoomSlider.step = capabilities.zoom.step;
                    zoomSlider.value = 1;
                    zoomMaxText.innerText = Math.round(capabilities.zoom.max) + "x";
                } else {
                    zoomUi.classList.remove('visible');
                }

                // --- НАСТРОЙКА ФОНАРИКА ---
                // Фонарик обычно есть только если есть 'torch' в capabilities
                // Но на iPhone иногда не показывает, но работает, поэтому просто чекаем заднюю камеру
                if (currentFacingMode === 'environment') {
                    btnTorch.disabled = false;
                } else {
                    btnTorch.disabled = true; // На селфи выключаем
                    video.classList.add('mirrored'); // И зеркалим видео
                }
                
                if(currentFacingMode === 'environment') video.classList.remove('mirrored');

                // Сброс кнопки фонарика
                isTorchOn = false;
                btnTorch.classList.remove('active');

            } catch (err) {
                console.error(err);
                statusText.innerText = "КАМЕРА НЕДОСТУПНА";
            }
        }

        // 3. Обработчики кнопок
        
        // Флип камеры
        btnFlip.addEventListener('click', () => {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            // Анимация иконки
            btnFlip.style.transform = "rotate(360deg)";
            setTimeout(() => btnFlip.style.transform = "rotate(0deg)", 300);
            startCamera();
        });

        // Фонарик
        btnTorch.addEventListener('click', async () => {
            if (!track) return;
            try {
                isTorchOn = !isTorchOn;
                await track.applyConstraints({ advanced: [{ torch: isTorchOn }] });
                btnTorch.classList.toggle('active', isTorchOn);
            } catch (e) {
                alert("Фонарик недоступен на этом устройстве");
                isTorchOn = !isTorchOn; // Откат
            }
        });

        // Зум
        zoomSlider.addEventListener('input', (e) => {
            if (!track) return;
            const zoomVal = parseFloat(e.target.value);
            track.applyConstraints({ advanced: [{ zoom: zoomVal }] });
        });

        // 4. Петля отрисовки (AI)
        video.addEventListener('play', () => {
            loadingScreen.style.opacity = '0';
            setTimeout(() => loadingScreen.style.display = 'none', 500);

            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            const loop = async () => {
                if (video.paused || video.ended) return;

                // Для скорости - detectSingleFace
                const detection = await faceapi.detectSingleFace(video, DETECTOR_OPTIONS).withAgeAndGender();
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (detection) {
                    // Ресайз под текущий размер экрана (важно при зуме, хотя зум оптический, но канвас статичен)
                    // Тут есть нюанс: оптический зум не меняет координаты внутри видеопотока, 
                    // поэтому face-api сам "найдет" увеличенное лицо. 
                    const dims = faceapi.matchDimensions(canvas, video, true);
                    const resized = faceapi.resizeResults(detection, dims);
                    
                    const box = resized.detection.box;
                    const age = Math.round(resized.age);

                    // Зеркалирование координат для отрисовки, если селфи
                    let centerX, leftX;
                    if (currentFacingMode === 'user') {
                         centerX = canvas.width - (box.x + box.width / 2);
                    } else {
                         centerX = box.x + box.width / 2;
                    }
                    
                    const centerY = box.y + box.height / 2;
                    const radius = (box.width / 1.5);

                    // Рисуем Круг
                    ctx.shadowColor = '#ff0000';
                    ctx.shadowBlur = 20;
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = '#ff0000';
                    ctx.stroke();

                    // Рисуем Текст
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#ff0000';
                    ctx.font = "bold 20px 'Courier New'";
                    ctx.textAlign = "center";
                    ctx.fillText(`~${age} YEARS`, centerX, centerY - radius - 15);
                }
                
                requestAnimationFrame(loop);
            };
            loop();
        });

        // Авторесайз
        window.addEventListener('resize', () => {
            faceapi.matchDimensions(canvas, { width: video.clientWidth, height: video.clientHeight });
        });

        window.onload = init;
    </script>
</body>
</html>
